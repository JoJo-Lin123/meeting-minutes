<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 會議助理 (修正版)</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Ionicons v7 -->
    <script type="module" src="https://unpkg.com/ionicons@7/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7/dist/ionicons/ionicons.js"></script>
    <style>
        /* 使用 Inter 字體 */
        body {
            font-family: "Inter", sans-serif;
        }
        /* 載入中動畫 */
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 客製化捲軸 */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        /* 活躍的分頁按鈕 */
        .tab-btn.active {
            background-color: #ffffff;
            color: #2563eb;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .tab-btn {
            background-color: #e2e8f0;
            color: #475569;
        }
        /* 增加下載按鈕樣式 */
        .download-btn {
            background-color: #10b981; /* green-500 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        .download-btn:hover {
            background-color: #059669; /* green-600 */
        }
        /* 負責人標籤樣式 */
        .responsible-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem; /* 4px */
            background-color: #e0e7ff; /* indigo-100 */
            color: #3730a3; /* indigo-800 */
            font-size: 0.75rem; /* 12px */
            font-weight: 500;
            padding: 0.125rem 0.5rem; /* 2px 8px */
            border-radius: 9999px; /* rounded-full */
            margin-top: 0.25rem; /* 4px */
        }
        /* 刪除按鈕樣式 */
        .delete-btn {
            background-color: #fee2e2; /* red-100 */
            color: #991b1b; /* red-800 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #fecaca; /* red-200 */
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <!-- Firebase SDK -->
    <script type="module">
        // 匯入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            addDoc,
            updateDoc,
            deleteDoc,
            onSnapshot,
            collection,
            query,
            getDoc,
            getDocs,
            where,
            writeBatch,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 全域變數 ---
        let db, auth, userId, appId;
        let meetings = []; // 儲存會議資料
        let globalActionItems = []; // 儲存所有待辦事項
        let currentMeetingId = null; // 當前選中的會議 ID
        let currentView = 'meetings'; // 'meetings' 或 'todos'
        let currentMeetingDataForForm = null; // 用於儲存表單的當前會議資料

        // Gemini API 金鑰 (保留為空字串)
        const geminiApiKey = "";
        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;

        // UI 元素 (延後到 DOMContentLoaded 中初始化)
        let meetingsListEl, mainContentEl, meetingFormEl, meetingDisplayEl, todosViewEl,
            globalTodosListEl, loadingOverlay, authStatusEl, newMeetingBtn, viewToggleContainer,
            viewToggleBtns, sidebarEl, errorOverlay, errorMessageText, closeErrorBtn,
            confirmOverlay, confirmMessageText, confirmBtn, cancelConfirmBtn,
            displayActionItemsListEl, formAiSummaryEl, formAiActionItemsEl,
            formSaveBtn, formAiBtn;

        // --- Firebase 初始化與認證 ---
        async function initFirebase() {
            try {
                // 修正：檢查 Canvas 環境變數
                let firebaseConfig;
                let isCanvasEnv = typeof __firebase_config !== 'undefined' && __firebase_config;

                if (isCanvasEnv) {
                    // 環境 1: 在 Canvas 預覽中
                    firebaseConfig = JSON.parse(__firebase_config);
                    appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                } else {
                    // 環境 2: 在 GitHub Pages 或本地開發
                    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    // !! 重要 !!
                    // !! 如果您要部署到 GitHub Pages，必須在此處填入您自己的 Firebase 專案設定
                    // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
                    firebaseConfig = {
                         apiKey: "AIzaSyDhlVBTqQsQ14Ew9PnFgW5_EYRUN0NxH_k",
                          authDomain: "meeting-minutes-dc6f2.firebaseapp.com",
                          projectId: "meeting-minutes-dc6f2",
                          storageBucket: "meeting-minutes-dc6f2.firebasestorage.app",
                          messagingSenderId: "679866135791",
                          appId: "1:679866135791:web:8e1edac3a0ddf17328171a"
                    };
                    appId = firebaseConfig.appId || 'default-app-id';

                    // 檢查金鑰是否已被替換
                    if (!firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_OWN_API_KEY") {
                        const errorMsg = "設定錯誤：應用程式無法連接到資料庫。請依照程式碼 'firebaseConfig' 物件上方的註解，填入您自己的 Firebase 專案金鑰。";
                        authStatusEl.textContent = "錯誤：Firebase 設定尚未替換。";
                        showErrorModal(errorMsg);
                        return;
                    }
                }

                // 設定 Firestore log 等級
                setLogLevel('Debug');

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 監聽認證狀態
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusEl.textContent = `使用者 ID: ${userId.substring(0, 8)}... (已登入)`;
                        listenToMeetings();
                        listenToGlobalActionItems();
                    } else {
                        // 嘗試登入
                        try {
                            if (isCanvasEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                // Canvas 環境使用 Token
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                // GitHub Pages 或其他環境，使用匿名登入
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Auth error:", error);
                            authStatusEl.textContent = "認證失敗";
                            showErrorModal(`認證失敗: ${error.message}`);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authStatusEl.textContent = "應用程式初始化失敗。";
                showErrorModal(`初始化失敗: ${error.message}`);
            }
        }

        // --- Firestore 資料監聽 ---

        // 監聽會議
        function listenToMeetings() {
            if (!userId) return;
            const meetingsColPath = `artifacts/${appId}/users/${userId}/meetings`;
            const q = query(collection(db, meetingsColPath));

            onSnapshot(q, (snapshot) => {
                meetings = [];
                snapshot.forEach((doc) => {
                    meetings.push({ id: doc.id, ...doc.data() });
                });
                meetings.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());

                if (currentView === 'meetings') {
                    renderMeetingsList();
                }
            }, (error) => {
                console.error("Error listening to meetings:", error);
            });
        }

        // 監聽全域待辦事項
        function listenToGlobalActionItems() {
            if (!userId) return;
            const actionItemsColPath = `artifacts/${appId}/users/${userId}/actionItems`;
            const q = query(collection(db, actionItemsColPath));

            onSnapshot(q, (snapshot) => {
                globalActionItems = [];
                snapshot.forEach((doc) => {
                    globalActionItems.push({ id: doc.id, ...doc.data() });
                });
                globalActionItems.sort((a, b) => {
                    const statusA = a.status === 'done' ? 1 : 0;
                    const statusB = b.status === 'done' ? 1 : 0;
                    if (statusA !== statusB) return statusA - statusB;
                    const timeA = a.createdAt?.toMillis() || 0;
                    const timeB = b.createdAt?.toMillis() || 0;
                    return timeB - timeA;
                });

                if (currentView === 'todos') {
                    renderGlobalTodosList();
                }

                if (currentView === 'meetings' && currentMeetingId) {
                    const meetingData = meetings.find(m => m.id === currentMeetingId);
                    if (meetingData) {
                        // 判斷當前在顯示頁還是表單頁
                        if (meetingFormEl.style.display === 'block') {
                            // 僅更新表單內的待辦事項
                            renderActionItemsForForm(currentMeetingId);
                        } else if (meetingDisplayEl.style.display === 'block') {
                            // 更新顯示頁的待辦事項
                            renderMeetingDisplay(meetingData);
                        }
                    }
                }
            }, (error) => {
                console.error("Error listening to global action items:", error);
            });
        }

        // --- 畫面渲染 ---

        // 渲染左側會議列表
        function renderMeetingsList() {
            meetingsListEl.innerHTML = '';
            if (meetings.length === 0) {
                meetingsListEl.innerHTML = '<p class="p-4 text-slate-500">尚無會議記錄。</p>';
                return;
            }

            meetings.forEach(meeting => {
                const li = document.createElement('li');
                li.className = `border-b border-slate-200 ${currentMeetingId === meeting.id ? 'bg-blue-100' : 'hover:bg-slate-50'}`;
                li.innerHTML = `
                    <button class="w-full text-left p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300" data-id="${meeting.id}">
                        <h3 class="font-semibold text-slate-900 truncate">${meeting.title || '未命名會議'}</h3>
                        <p class="text-sm text-slate-500">${formatDate(meeting.createdAt)}</p>
                    </button>
                `;
                li.querySelector('button').addEventListener('click', () => {
                    currentMeetingId = meeting.id;
                    renderMeetingsList();
                    const selectedMeeting = meetings.find(m => m.id === currentMeetingId);
                    if (selectedMeeting) {
                        renderMeetingDisplay(selectedMeeting);
                    }
                });
                meetingsListEl.appendChild(li);
            });
        }

        // 顯示新會議表單
        function showNewMeetingForm() {
            currentMeetingId = null;
            currentMeetingDataForForm = null;
            meetingFormEl.style.display = 'block';
            meetingDisplayEl.style.display = 'none';
            todosViewEl.style.display = 'none';

            meetingFormEl.querySelector('form').reset();
            document.getElementById('form-title').textContent = '新增會議記錄';
            formAiSummaryEl.innerHTML = '<p class="text-slate-500 italic">點擊「AI 分析」按鈕以產生摘要。</p>';
            formAiActionItemsEl.innerHTML = '<p class="text-slate-500 italic">點擊「AI 分析」按鈕以提取待辦事項。</p>';

            updateFormButtons(false, false);
            renderMeetingsList();
        }

        // 顯示已儲存的會議 (檢視模式)
        function renderMeetingDisplay(meeting) {
            meetingFormEl.style.display = 'none';
            meetingDisplayEl.style.display = 'block';
            todosViewEl.style.display = 'none';

            document.getElementById('display-title').textContent = meeting.title || '未命名會議';
            document.getElementById('display-date').textContent = formatDate(meeting.createdAt);
            document.getElementById('display-recorder').textContent = `會議記錄: ${meeting.recorder || '未記錄'}`;
            document.getElementById('display-attendees').textContent = `出席者: ${meeting.attendees ? meeting.attendees.join(', ') : '未記錄'}`;

            document.getElementById('display-notes').innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-slate-700">原始筆記</h3>
                <div class="prose prose-slate max-w-none bg-white p-4 rounded-md border border-slate-200 whitespace-pre-wrap">${escapeHTML(meeting.notes) || '無'}</div>
            `;
            document.getElementById('display-summary').innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-slate-700">AI 摘要</h3>
                <div class="prose prose-slate max-w-none bg-white p-4 rounded-md border border-slate-200">${meeting.summary || '無'}</div>
            `;

            // 渲染待辦事項
            displayActionItemsListEl.innerHTML = '';
            const meetingActionItems = globalActionItems.filter(item => item.meetingId === meeting.id);

            if (meetingActionItems.length > 0) {
                meetingActionItems.forEach(item => {
                    const li = createActionItemElement(item, false); // 不顯示會議標題
                    displayActionItemsListEl.appendChild(li);
                });
                attachActionItemListeners(displayActionItemsListEl);
            } else {
                displayActionItemsListEl.innerHTML = '<p class="p-4 text-slate-500">沒有待辦事項。</p>';
            }

            // 下載按鈕
            const downloadBtnContainer = document.getElementById('download-btn-container');
            downloadBtnContainer.innerHTML = '';
            const downloadBtn = document.createElement('button');
            downloadBtn.className = 'download-btn';
            downloadBtn.innerHTML = `<ion-icon name="download-outline"></ion-icon><span>下載 (HTML)</span>`;
            downloadBtn.addEventListener('click', () => downloadMeetingMinutes(meeting));
            downloadBtnContainer.appendChild(downloadBtn);

            // 編輯按鈕
            const editBtnContainer = document.getElementById('edit-btn-container');
            editBtnContainer.innerHTML = '';
            const editBtn = document.createElement('button');
            editBtn.className = 'bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-semibold py-2 px-4 rounded-lg shadow transition duration-150 ease-in-out flex items-center justify-center gap-1 text-sm';
            editBtn.innerHTML = `<ion-icon name="pencil-outline" class="text-base"></ion-icon><span>編輯</span>`;
            editBtn.addEventListener('click', () => showEditMeetingForm(meeting));
            editBtnContainer.appendChild(editBtn);
            
            // 刪除按鈕
            const deleteBtnContainer = document.getElementById('delete-btn-container');
            deleteBtnContainer.innerHTML = '';
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn text-sm py-2 px-4';
            deleteBtn.innerHTML = `<ion-icon name="trash-outline" class="text-base"></ion-icon><span>刪除會議</span>`;
            deleteBtn.addEventListener('click', () => {
                showConfirmModal(
                    '您確定要刪除這場會議嗎？',
                    '此操作將同時刪除所有相關的待辦事項，且無法復原。',
                    () => deleteMeeting(meeting.id)
                );
            });
            deleteBtnContainer.appendChild(deleteBtn);
        }

        // 顯示編輯會議表單
        function showEditMeetingForm(meeting) {
            currentMeetingId = meeting.id;
            currentMeetingDataForForm = meeting; // 儲存當前資料
            meetingFormEl.style.display = 'block';
            meetingDisplayEl.style.display = 'none';
            todosViewEl.style.display = 'none';

            document.getElementById('form-title').textContent = '編輯會議記錄';
            document.getElementById('meeting-title').value = meeting.title || '';
            document.getElementById('meeting-recorder').value = meeting.recorder || '';
            document.getElementById('meeting-attendees').value = meeting.attendees ? meeting.attendees.join(', ') : '';
            document.getElementById('meeting-notes').value = meeting.notes || '';

            formAiSummaryEl.innerHTML = meeting.summary ? 
                `<div class="prose prose-slate max-w-none">${meeting.summary}</div>` : 
                '<p class="text-slate-500 italic">點擊「AI 分析」按鈕以產生摘要。</p>';

            renderActionItemsForForm(meeting.id);
            updateFormButtons(true, false); // 已儲存，未分析
        }
        
        // 顯示全域待辦事項列表
        function renderGlobalTodosList() {
            meetingFormEl.style.display = 'none';
            meetingDisplayEl.style.display = 'none';
            todosViewEl.style.display = 'block';
            globalTodosListEl.innerHTML = '';

            if (globalActionItems.length === 0) {
                globalTodosListEl.innerHTML = '<p class="p-4 text-slate-500">太好了！沒有任何待辦事項。</p>';
                return;
            }

            const pendingItems = globalActionItems.filter(item => item.status !== 'done');
            const doneItems = globalActionItems.filter(item => item.status === 'done');

            if (pendingItems.length > 0) {
                globalTodosListEl.innerHTML += `<h3 class="text-xl font-semibold mb-3 text-slate-700">進行中 (${pendingItems.length})</h3>`;
                const pendingList = document.createElement('ul');
                pendingList.className = 'space-y-3';
                pendingItems.forEach(item => {
                    const li = createActionItemElement(item, true); // 顯示會議標題
                    pendingList.appendChild(li);
                });
                globalTodosListEl.appendChild(pendingList);
            }

            if (doneItems.length > 0) {
                globalTodosListEl.innerHTML += `<h3 class="text-xl font-semibold mb-3 mt-8 text-slate-500">已完成 (${doneItems.length})</h3>`;
                const doneList = document.createElement('ul');
                doneList.className = 'space-y-3';
                doneItems.forEach(item => {
                    const li = createActionItemElement(item, true);
                    li.classList.add('opacity-70');
                    doneList.appendChild(li);
                });
                globalTodosListEl.appendChild(doneList);
            }
            
            attachActionItemListeners(globalTodosListEl);
        }

        // --- 共用的待辦事項 UI 產生器 ---

        // (在表單中) 渲染待辦事項
        function renderActionItemsForForm(meetingId) {
            formAiActionItemsEl.innerHTML = '';
            const meetingActionItems = globalActionItems.filter(item => item.meetingId === meetingId);

            if (meetingActionItems.length > 0) {
                const list = document.createElement('ul');
                list.className = 'space-y-3';
                meetingActionItems.forEach(item => {
                    // 傳入 true 啟用刪除按鈕
                    const li = createActionItemElement(item, false, true); 
                    list.appendChild(li);
                });
                formAiActionItemsEl.appendChild(list);
                attachActionItemListeners(formAiActionItemsEl);
            } else {
                formAiActionItemsEl.innerHTML = '<p class="text-slate-500 italic">此會議尚無待辦事項。</p>';
            }
        }

        // 建立單個待辦事項的 HTML 元素
        function createActionItemElement(item, showMeetingTitle = false, enableDelete = false) {
            const li = document.createElement('li');
            li.className = 'flex flex-col gap-4 p-4 bg-white rounded-lg shadow-sm border border-slate-200 group';
            li.setAttribute('data-item-id', item.id); 

            // 進度更新列表
            let progressHtml = '<ul class="space-y-2 mt-3 border-t border-slate-200 pt-3">';
            if (item.progress && item.progress.length > 0) {
                const sortedProgress = [...item.progress].sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                sortedProgress.forEach(update => {
                    const progressTimestamp = update.createdAt?.toMillis() || Date.now(); 
                    progressHtml += `
                        <li class="text-sm text-slate-600 break-words group" data-timestamp="${progressTimestamp}">
                            <div class="progress-display flex justify-between items-start gap-2">
                                <span class="progress-text flex-1">
                                    <span class="font-medium text-slate-500">${formatDate(update.createdAt)}:</span>
                                    ${escapeHTML(update.text)}
                                </span>
                                <button class="edit-progress-btn p-1 text-slate-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0" data-progress-timestamp="${progressTimestamp}">
                                    <ion-icon name="pencil-outline" class="text-base"></ion-icon>
                                </button>
                            </div>
                            <div class="progress-edit" style="display: none;">
                                <textarea class="w-full p-2 border border-slate-300 rounded-md text-sm mt-1">${escapeHTML(update.text)}</textarea>
                                <div class="flex gap-2 mt-1 justify-end">
                                    <button class="cancel-edit-btn bg-gray-200 hover:bg-gray-300 text-slate-700 text-xs py-1 px-2 rounded">取消</button>
                                    <button class="save-progress-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded" data-progress-timestamp="${progressTimestamp}">儲存</button>
                                </div>
                            </div>
                        </li>
                    `;
                });
            } else {
                progressHtml += '<li class="text-sm text-slate-400 italic">尚無進度更新。</li>';
            }
            progressHtml += '</ul>';

            // 新增進度表單
            const progressInputId = `progress-input-${item.id}`;
            const addProgressHtml = `
                <div class_E_S_S_ = "flex gap-2 mt-3 border-t border-slate-200 pt-3">
                    <input type="text" id="${progressInputId}" class="flex-1 p-2 border border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="新增進度說明...">
                    <button class="add-progress-btn flex-shrink-0 bg-gray-200 hover:bg-gray-300 text-slate-700 font-semibold py-2 px-3 rounded-md text-sm" data-input-id="${progressInputId}">
                        新增
                    </button>
                </div>
            `;

            const status = item.status || 'todo';
            const colorClasses = getStatusColorClasses(status);
            
            const meetingTitleHtml = showMeetingTitle ? `
                <p class="text-xs text-blue-600 font-medium mb-1 truncate">
                    <ion-icon name="document-text-outline" class="inline-block align-text-bottom"></ion-icon>
                    ${escapeHTML(item.meetingTitle || '未知會議')}
                </p>` : '';
            
            // 刪除按鈕 (僅在 enableDelete 為 true 時顯示)
            const deleteButtonHtml = enableDelete ? `
                <button class="delete-action-item-btn p-1 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                    <ion-icon name="trash-outline" class="text-base"></ion-icon>
                </button>
                ` : '';

            li.innerHTML = `
                <div class="action-item-display">
                    ${meetingTitleHtml}
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-slate-800 break-words">${escapeHTML(item.item)}</p>
                            <span class="responsible-badge">
                                <ion-icon name="person-outline" class="text-sm"></ion-icon>
                                <span>${escapeHTML(item.responsible || '未指定')}</span>
                            </span>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                            <button class="edit-action-item-btn p-1 text-slate-400 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                <ion-icon name="pencil-outline" class="text-base"></ion-icon>
                            </button>
                            ${deleteButtonHtml}
                            <select class="status-select rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm ${colorClasses} transition-colors duration-150">
                                <option value="todo" ${status === 'todo' ? 'selected' : ''}>待辦</option>
                                <option value="inprogress" ${status === 'inprogress' ? 'selected' : ''}>進行中</option>
                                <option value="done" ${status === 'done' ? 'selected' : ''}>已完成</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="action-item-edit" style="display: none;">
                    <div class="space-y-2">
                        <div>
                            <label class="text-xs font-medium text-slate-600">任務描述</label>
                            <textarea class="w-full p-2 border border-slate-300 rounded-md text-sm action-item-edit-text">${escapeHTML(item.item)}</textarea>
                        </div>
                        <div>
                            <label class="text-xs font-medium text-slate-600">負責人</label>
                            <input type="text" class="w-full p-2 border border-slate-300 rounded-md text-sm action-item-edit-responsible" value="${escapeHTML(item.responsible || '')}">
                        </div>
                    </div>
                    <div class="flex gap-2 mt-2 justify-end">
                        <button class="cancel-action-item-btn bg-gray-200 hover:bg-gray-300 text-slate-700 text-xs py-1 px-2 rounded">取消</button>
                        <button class="save-action-item-btn bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-2 rounded">儲存</button>
                    </div>
                </div>

                <div class="action-item-progress-area">
                    ${progressHtml}
                    ${addProgressHtml}
                </div>
            `;
            return li;
        }

        // --- 共用的待辦事項事件綁定 ---
        function attachActionItemListeners(containerElement) {
            
            const getItemId = (e) => e.currentTarget.closest('li[data-item-id]').dataset.itemId;

            // 狀態變更
            containerElement.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const newStatus = e.target.value;
                    const itemId = getItemId(e);
                    e.target.classList.remove('bg-gray-200', 'text-gray-800', 'bg-yellow-200', 'text-yellow-800', 'bg-green-200', 'text-green-800', 'bg-gray-100', 'text-slate-800');
                    const newClasses = getStatusColorClasses(newStatus).split(' ');
                    e.target.classList.add(...newClasses);
                    updateActionItemStatus(itemId, newStatus);
                });
            });

            // 新增進度
            containerElement.querySelectorAll('.add-progress-btn').forEach(btn => {
                const inputEl = document.getElementById(btn.dataset.inputId);
                
                const addHandler = (e) => {
                    const itemId = getItemId(e);
                    if (inputEl) {
                        const updateText = inputEl.value;
                        if (updateText.trim()) {
                            addProgressUpdate(itemId, updateText);
                            inputEl.value = '';
                        }
                    }
                };
                
                btn.addEventListener('click', addHandler);

                if (inputEl) {
                    inputEl.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); 
                            addHandler(e); // 傳遞事件物件
                        }
                    });
                }
            });

            // 編輯進度留言 (鉛筆)
            containerElement.querySelectorAll('.edit-progress-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const li = e.currentTarget.closest('li[data-timestamp]');
                    li.querySelector('.progress-display').style.display = 'none';
                    li.querySelector('.progress-edit').style.display = 'block';
                });
            });

            // 取消編輯 (進度留言)
            containerElement.querySelectorAll('.cancel-edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const li = e.currentTarget.closest('li[data-timestamp]');
                    const textarea = li.querySelector('.progress-edit textarea');
                    const originalText = li.querySelector('.progress-text').textContent.split(':').slice(1).join(':').trim();
                    textarea.value = originalText; 
                    li.querySelector('.progress-display').style.display = 'flex';
                    li.querySelector('.progress-edit').style.display = 'none';
                });
            });

            // 儲存進度留言
            containerElement.querySelectorAll('.save-progress-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = getItemId(e);
                    const progressTimestamp = parseInt(e.currentTarget.dataset.progressTimestamp);
                    const li = e.currentTarget.closest('li[data-timestamp]');
                    const newText = li.querySelector('.progress-edit textarea').value;
                    if (newText.trim()) {
                        updateProgressUpdateText(itemId, progressTimestamp, newText.trim());
                    }
                });
            });

            // 編輯待辦事項 (鉛筆)
            containerElement.querySelectorAll('.edit-action-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const li = e.currentTarget.closest('li[data-item-id]');
                    li.querySelector('.action-item-display').style.display = 'none';
                    li.querySelector('.action-item-edit').style.display = 'block';
                    li.querySelector('.action-item-progress-area').style.display = 'none';
                });
            });

            // 取消編輯 (待辦事項)
            containerElement.querySelectorAll('.cancel-action-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const li = e.currentTarget.closest('li[data-item-id]');
                    const itemId = getItemId(e);
                    const originalItem = globalActionItems.find(item => item.id === itemId);
                    
                    li.querySelector('.action-item-edit-text').value = originalItem.item;
                    li.querySelector('.action-item-edit-responsible').value = originalItem.responsible || '';

                    li.querySelector('.action-item-display').style.display = 'block';
                    li.querySelector('.action-item-edit').style.display = 'none';
                    li.querySelector('.action-item-progress-area').style.display = 'block';
                });
            });

            // 儲存待辦事項
            containerElement.querySelectorAll('.save-action-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = getItemId(e);
                    const li = e.currentTarget.closest('li[data-item-id]');
                    const newText = li.querySelector('.action-item-edit-text').value;
                    const newResponsible = li.querySelector('.action-item-edit-responsible').value;
                    
                    if (newText.trim()) {
                        updateActionItemDetails(itemId, newText.trim(), newResponsible.trim());
                    } else {
                        showErrorModal("任務描述不可為空。");
                        li.querySelector('.action-item-edit-text').focus();
                    }
                });
            });

            // 刪除待辦事項 (垃圾桶)
            containerElement.querySelectorAll('.delete-action-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = getItemId(e);
                    showConfirmModal(
                        '您確定要刪除這個待辦事項嗎？',
                        '此操作無法復原。',
                        () => deleteActionItem(itemId)
                    );
                });
            });
        }
        
        // --- 輔助函式 ---

        function formatDate(timestamp) {
            if (!timestamp) return '未知日期';
            const date = timestamp.toDate();
            return date.toLocaleString('zh-TW', { 
                year: 'numeric', month: 'numeric', day: 'numeric', 
                hour: '2-digit', minute: '2-digit'
            });
        }
        
        function getStatusColorClasses(status) {
            switch(status) {
                case 'todo': return 'bg-gray-200 text-gray-800';
                case 'inprogress': return 'bg-yellow-200 text-yellow-800';
                case 'done': return 'bg-green-200 text-green-800';
                default: return 'bg-gray-100 text-slate-800';
            }
        }

        function escapeHTML(str) {
            if (typeof str !== 'string') return str;
            return str.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;', '<': '&lt;', '>': '&gt;',
                    '"': '&quot;', "'": '&#039;'
                }[m];
            });
        }
        
        function showLoading(message) {
            loadingOverlay.querySelector('p').textContent = message || '處理中...';
            loadingOverlay.style.display = 'flex';
        }

        function hideLoading() {
            loadingOverlay.style.display = 'none';
        }

        function showErrorModal(message) {
            errorMessageText.textContent = message;
            errorOverlay.style.display = 'flex';
        }

        function hideErrorModal() {
            errorOverlay.style.display = 'none';
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            confirmMessageText.textContent = message;
            confirmOverlay.style.display = 'flex';
            
            // 移除舊監聽器，綁定新監聽器
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            confirmBtn = newConfirmBtn;
            confirmBtn.textContent = "確定";
            confirmBtn.addEventListener('click', () => {
                onConfirm();
                hideConfirmModal();
            }, { once: true }); // 確保只觸發一次
        }

        function hideConfirmModal() {
            confirmOverlay.style.display = 'none';
        }

        // --- 表單按鈕狀態管理 ---
        function updateFormButtons(isSaved, hasAnalyzed) {
            if (isSaved) {
                // 已儲存 (編輯模式)
                formSaveBtn.textContent = '儲存會議與 AI 結果';
                formSaveBtn.className = "w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2";
                
                formAiBtn.disabled = false;
                formAiBtn.textContent = hasAnalyzed ? '重新由 AI 分析' : 'AI 分析 (需先儲存)';
                formAiBtn.className = hasAnalyzed ? 
                    "w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2" :
                    "w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2";
            } else {
                // 未儲存 (新增模式)
                formSaveBtn.textContent = '儲存並由 AI 分析';
                formSaveBtn.className = "w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2";
                
                formAiBtn.disabled = true;
                formAiBtn.textContent = 'AI 分析 (需先儲存)';
                formAiBtn.className = "w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2 cursor-not-allowed";
            }
        }


        // --- Gemini API 呼叫 ---
        async function getAiSummary(notes) {
            const systemPrompt = `
                你是一個專業的會議助理。請根據以下中文會議記錄，完成兩項任務：
                1.  **產生摘要 (summary):** 產生一段精簡的會議摘要，總結會議的關鍵討論點和結論。請使用繁體中文。
                2.  **提取待辦事項 (actionItems):** 提取所有明確的待辦事項。
                    - 每一項待辦事項 (action item) 必須包含 'item' (任務描述) 和 'responsible' (負責人)。
                    - 如果找不到明確的負責人，請將 'responsible' 設為 '未指定'。

                請嚴格依照以下的 JSON 格式回傳，不要有任何多餘的文字或 markdown 標記：
            `;
            const schema = {
                type: "OBJECT",
                properties: {
                    summary: { type: "STRING" },
                    actionItems: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                item: { type: "STRING" },
                                responsible: { type: "STRING" }
                            },
                            required: ["item", "responsible"]
                        }
                    }
                },
                required: ["summary", "actionItems"]
            };
            const payload = {
                contents: [{ parts: [{ text: notes }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };
            
            try {
                let response;
                let delay = 1000;
                for (let i = 0; i < 3; i++) {
                    response = await fetch(geminiApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) break;
                    if (response.status === 429 || response.status >= 500) {
                        console.warn(`Gemini API request failed with status ${response.status}. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw new Error(`Gemini API 請求失敗，狀態碼: ${response.status}`);
                    }
                }
                if (!response.ok) {
                    throw new Error(`Gemini API 請求失敗，狀態碼: ${response.status} (可能是額度已用完)`);
                }
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const jsonString = candidate.content.parts[0].text;
                    return JSON.parse(jsonString);
                } else {
                    const blockReason = candidate?.finishReason;
                    if (blockReason) {
                        throw new Error(`AI 因 ${blockReason} 理由拒絕回應。`);
                    }
                    throw new Error("AI 無法處理您的請求，回傳的資料格式不符。");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw new Error(`AI 分析失敗: ${error.message}`); 
            }
        }


        // --- Firestore 資料操作 ---

        // 處理表單提交 (儲存會議 / 新增會議)
        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!userId) return showErrorModal("錯誤：使用者未登入。");

            const title = document.getElementById('meeting-title').value || '未命名會議';
            const attendees = document.getElementById('meeting-attendees').value.split(',').map(s => s.trim()).filter(Boolean);
            const notes = document.getElementById('meeting-notes').value;
            const recorder = document.getElementById('meeting-recorder').value;
            const summary = currentMeetingDataForForm?.summary || ''; // 讀取現有摘要

            if (!notes.trim()) {
                showErrorModal("會議筆記不能為空。");
                return;
            }

            const meetingData = {
                title,
                attendees,
                notes,
                recorder,
                summary, // 包含已有的摘要
                updatedAt: Timestamp.now(), // 使用 updatedAt
                userId: userId
            };

            showLoading('儲存會議中...');

            try {
                if (currentMeetingId) {
                    // 更新現有會議
                    const meetingDocRef = doc(db, `artifacts/${appId}/users/${userId}/meetings`, currentMeetingId);
                    await updateDoc(meetingDocRef, meetingData);
                    
                    // 更新 currentMeetingDataForForm
                    currentMeetingDataForForm = { ...currentMeetingDataForForm, ...meetingData };
                    updateFormButtons(true, !!currentMeetingDataForForm.summary); // 更新按鈕狀態
                } else {
                    // 新增會議
                    meetingData.createdAt = Timestamp.now(); // 新增時才加 createdAt
                    const meetingsColPath = `artifacts/${appId}/users/${userId}/meetings`;
                    const meetingDocRef = await addDoc(collection(db, meetingsColPath), meetingData);
                    
                    currentMeetingId = meetingDocRef.id;
                    currentMeetingDataForForm = { id: currentMeetingId, ...meetingData };
                    
                    // 更新左側列表高亮
                    renderMeetingsList(); 
                    updateFormButtons(true, false); // 更新按鈕狀態 (已儲存，未分析)
                }

            } catch (error) {
                console.error("Error saving meeting:", error);
                showErrorModal(`儲存失敗：${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // 觸發 AI 分析 (僅限已儲存的會議)
        async function handleAiAnalysis() {
            if (!currentMeetingId || !currentMeetingDataForForm) {
                showErrorModal("請先儲存會議，才能進行 AI 分析。");
                return;
            }

            const notes = document.getElementById('meeting-notes').value;
            if (!notes.trim()) {
                showErrorModal("會議筆記不能為空，無法進行分析。");
                return;
            }

            showLoading('AI 分析中，請稍候...');

            try {
                // 1. 呼叫 AI
                const aiResult = await getAiSummary(notes);
                const { summary, actionItems } = aiResult;

                // 2. 更新會議文件 (僅更新摘要)
                const meetingDocRef = doc(db, `artifacts/${appId}/users/${userId}/meetings`, currentMeetingId);
                await updateDoc(meetingDocRef, {
                    summary: summary,
                    updatedAt: Timestamp.now()
                });
                
                // 更新 UI 上的摘要
                formAiSummaryEl.innerHTML = `<div class="prose prose-slate max-w-none">${summary}</div>`;
                currentMeetingDataForForm.summary = summary; // 更新本地快取

                // 3. 處理待辦事項
                // 為了避免重複，我們先刪除此會議舊的待辦事項
                showLoading('更新待辦事項中...');
                await deleteActionItemsByMeetingId(currentMeetingId);

                // 4. 批次新增 AI 提取的新待辦事項
                const actionItemsColPath = `artifacts/${appId}/users/${userId}/actionItems`;
                const batch = writeBatch(db);
                actionItems.forEach(item => {
                    const newItemRef = doc(collection(db, actionItemsColPath)); // 產生新 ID
                    const itemData = {
                        ...item,
                        status: 'todo',
                        progress: [],
                        createdAt: Timestamp.now(),
                        meetingId: currentMeetingId,
                        meetingTitle: currentMeetingDataForForm.title || '未命名會議'
                    };
                    batch.set(newItemRef, itemData);
                });
                await batch.commit();

                // 5. 更新按鈕狀態
                updateFormButtons(true, true);
                // onSnapshot 會自動更新表單中的待辦事項列表

            } catch (error) {
                console.error("Error during AI analysis:", error);
                showErrorModal(`AI 分析失敗：${error.message}`);
            } finally {
                hideLoading();
            }
        }

        // 更新待辦事項狀態
        async function updateActionItemStatus(itemId, newStatus) {
            if (!userId || !itemId) return;
            try {
                const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/actionItems`, itemId);
                await updateDoc(itemDocRef, { status: newStatus });
            } catch (error) {
                console.error("Error updating status:", error);
            }
        }

        // 更新待辦事項內容
        async function updateActionItemDetails(itemId, newItemText, newResponsibleText) {
            if (!userId || !itemId || !newItemText) return;
            showLoading('更新待辦事項中...');
            try {
                const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/actionItems`, itemId);
                await updateDoc(itemDocRef, {
                    item: newItemText,
                    responsible: newResponsibleText || '未指定'
                });
            } catch (error) {
                console.error("Error updating action item details:", error);
                showErrorModal("更新待辦事項失敗。");
            } finally {
                hideLoading();
            }
        }

        // 編輯進度留言
        async function updateProgressUpdateText(itemId, progressTimestampMillis, newText) {
            if (!userId || !itemId) return;
            showLoading('更新留言中...');
            const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/actionItems`, itemId);
            try {
                const docSnap = await getDoc(itemDocRef);
                if (!docSnap.exists()) throw new Error("找不到待辦事項");
                
                const itemData = docSnap.data();
                const currentProgress = itemData.progress || [];
                const progressIndex = currentProgress.findIndex(p => p.createdAt?.toMillis() === progressTimestampMillis);
                
                if (progressIndex === -1) throw new Error("找不到該留言");

                const updatedProgress = [...currentProgress];
                updatedProgress[progressIndex] = { ...updatedProgress[progressIndex], text: newText };
                
                await updateDoc(itemDocRef, { progress: updatedProgress });
            } catch (error) {
                console.error("Error updating progress text:", error);
                showErrorModal("更新留言失敗。");
            } finally {
                hideLoading();
            }
        }

        // 新增進度更新
        async function addProgressUpdate(itemId, updateText) {
            if (!userId || !itemId || !updateText.trim()) return;

            const newUpdate = {
                text: updateText.trim(),
                createdAt: Timestamp.now()
            };

            showLoading('新增進度中...');
            const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/actionItems`, itemId);
            try {
                const docSnap = await getDoc(itemDocRef);
                if (!docSnap.exists()) throw new Error("找不到待辦事項");
                const itemData = docSnap.data();
                const currentProgress = itemData.progress || [];
                const updatedProgress = [newUpdate, ...currentProgress];
                await updateDoc(itemDocRef, { progress: updatedProgress });
            } catch (error) {
                console.error("Error adding progress update:", error);
                showErrorModal("新增進度失敗。");
            } finally {
                hideLoading();
            }
        }

        // 刪除單個待辦事項
        async function deleteActionItem(itemId) {
            if (!userId || !itemId) return;
            showLoading('刪除待辦事項中...');
            try {
                const itemDocRef = doc(db, `artifacts/${appId}/users/${userId}/actionItems`, itemId);
                await deleteDoc(itemDocRef);
            } catch (error) {
                console.error("Error deleting action item:", error);
                showErrorModal("刪除待辦事項失敗。");
            } finally {
                hideLoading();
            }
        }
        
        // 根據 Meeting ID 刪除所有相關待辦事項
        async function deleteActionItemsByMeetingId(meetingId) {
            if (!userId || !meetingId) return;
            
            const actionItemsColPath = `artifacts/${appId}/users/${userId}/actionItems`;
            const q = query(collection(db, actionItemsColPath), where("meetingId", "==", meetingId));
            
            try {
                const querySnapshot = await getDocs(q);
                const batch = writeBatch(db);
                querySnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
            } catch (error) {
                console.error("Error deleting related action items:", error);
                // 即使刪除失敗，也繼續刪除主會議
                showErrorModal("刪除相關待辦事項時發生錯誤，但仍會嘗試刪除會議。");
            }
        }

        // 刪除會議 (及相關待辦)
        async function deleteMeeting(meetingId) {
            if (!userId || !meetingId) return;
            
            showLoading('刪除相關待辦事項中...');
            await deleteActionItemsByMeetingId(meetingId);

            showLoading('刪除會議中...');
            try {
                const meetingDocRef = doc(db, `artifacts/${appId}/users/${userId}/meetings`, meetingId);
                await deleteDoc(meetingDocRef);
                
                // 清理當前視圖
                showNewMeetingForm();
                
            } catch (error) {
                console.error("Error deleting meeting:", error);
                showErrorModal("刪除會議失敗。");
            } finally {
                hideLoading();
            }
        }

        // 下載會議記錄
        function downloadMeetingMinutes(meeting) {
            const meetingActionItems = globalActionItems.filter(item => item.meetingId === meeting.id);
            
            let actionItemsHtml = '<h3>尚無待辦事項</h3>';
            if (meetingActionItems.length > 0) {
                actionItemsHtml = '<ul style="list-style-type: disc; margin-left: 20px;">';
                meetingActionItems.forEach(item => {
                    actionItemsHtml += `
                        <li>
                            <strong>${escapeHTML(item.item)}</strong> (負責人: ${escapeHTML(item.responsible || '未指定')}) - 狀態: ${escapeHTML(item.status)}
                        </li>
                    `;
                });
                actionItemsHtml += '</ul>';
            }

            const htmlContent = `
                <!DOCTYPE html>
                <html lang="zh-Hant">
                <head>
                    <meta charset="UTF-8">
                    <title>${escapeHTML(meeting.title)}</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: auto; }
                        h1 { color: #333; }
                        h2 { color: #555; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 30px; }
                        p { color: #444; }
                        ul { margin-bottom: 20px; }
                        .summary { background: #f4f7f6; padding: 15px; border-left: 4px solid #4a90e2; }
                        .notes { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border: 1px solid #eee; }
                    </style>
                </head>
                <body>
                    <h1>${escapeHTML(meeting.title)}</h1>
                    <p><strong>會議日期:</strong> ${formatDate(meeting.createdAt)}</p>
                    <p><strong>會議記錄:</strong> ${escapeHTML(meeting.recorder || '未記錄')}</p>
                    <p><strong>出席人員:</strong> ${escapeHTML(meeting.attendees ? meeting.attendees.join(', ') : '未記錄')}</p>
                    
                    <h2>AI 摘要</h2>
                    <div class="summary">
                        ${meeting.summary || '無'}
                    </div>
                    
                    <h2>待辦事項</h2>
                    ${actionItemsHtml}
                    
                    <h2>原始筆記</h2>
                    <div class="notes">${escapeHTML(meeting.notes)}</div>
                    
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${meeting.title || '會議記錄'}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- 視圖切換 ---
        function switchView(viewName) {
            currentView = viewName;
            
            viewToggleBtns.forEach(btn => {
                if (btn.dataset.view === viewName) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            if (viewName === 'meetings') {
                sidebarEl.style.display = 'flex';
                if (currentMeetingId) {
                    const meeting = meetings.find(m => m.id === currentMeetingId);
                    if(meeting) renderMeetingDisplay(meeting);
                    else showNewMeetingForm();
                } else {
                    showNewMeetingForm();
                }
                renderMeetingsList();
            } else if (viewName === 'todos') {
                sidebarEl.style.display = 'none';
                meetingFormEl.style.display = 'none';
                meetingDisplayEl.style.display = 'none';
                todosViewEl.style.display = 'block';
                renderGlobalTodosList();
            }
        }

        // --- 啟動 ---
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化 UI 元素
            meetingsListEl = document.getElementById('meetings-list');
            mainContentEl = document.getElementById('main-content');
            meetingFormEl = document.getElementById('meeting-form');
            meetingDisplayEl = document.getElementById('meeting-display');
            todosViewEl = document.getElementById('todos-view');
            globalTodosListEl = document.getElementById('global-todos-list');
            loadingOverlay = document.getElementById('loading-overlay');
            authStatusEl = document.getElementById('auth-status');
            newMeetingBtn = document.getElementById('new-meeting-btn');
            viewToggleContainer = document.getElementById('view-toggle-container');
            viewToggleBtns = document.querySelectorAll('.tab-btn');
            sidebarEl = document.getElementById('sidebar');
            errorOverlay = document.getElementById('error-overlay');
            errorMessageText = document.getElementById('error-message-text');
            closeErrorBtn = document.getElementById('close-error-btn');
            confirmOverlay = document.getElementById('confirm-overlay');
            confirmMessageText = document.getElementById('confirm-message-text');
            confirmBtn = document.getElementById('confirm-btn');
            cancelConfirmBtn = document.getElementById('cancel-confirm-btn');
            displayActionItemsListEl = document.getElementById('display-action-items-list');
            formAiSummaryEl = document.getElementById('form-ai-summary');
            formAiActionItemsEl = document.getElementById('form-ai-action-items');
            formSaveBtn = document.getElementById('form-save-btn');
            formAiBtn = document.getElementById('form-ai-btn');

            // 綁定事件
            initFirebase();
            meetingFormEl.querySelector('form').addEventListener('submit', handleFormSubmit);
            formAiBtn.addEventListener('click', handleAiAnalysis);
            newMeetingBtn.addEventListener('click', showNewMeetingForm);
            viewToggleBtns.forEach(btn => {
                btn.addEventListener('click', () => switchView(btn.dataset.view));
            });
            closeErrorBtn.addEventListener('click', hideErrorModal);
            cancelConfirmBtn.addEventListener('click', hideConfirmModal);

            // 初始顯示
            switchView('meetings');
            showNewMeetingForm();
        });

    </script>

    <!-- 主結構 -->
    <div class="flex h-screen bg-slate-100">

        <!-- 左側邊欄: 會議列表 -->
        <aside id="sidebar" class="w-1/3 max-w-sm h-full flex flex-col bg-white border-r border-slate-200">
            <header class="p-4 border-b border-slate-200 flex-shrink-0">
                <h1 class="text-2xl font-bold text-blue-600">AI 會議助理</h1>
                <p id="auth-status" class="text-xs text-slate-400 mt-1">初始化中...</p>
            </header>
            
            <div class="p-4 border-b border-slate-200 flex-shrink-0 flex justify-between items-center">
                 <h2 class="text-lg font-semibold text-slate-800">會議列表</h2>
                <button id="new-meeting-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-3 rounded-lg shadow transition duration-150 ease-in-out flex items-center justify-center gap-1 text-sm">
                    <ion-icon name="add-circle-outline" class="text-lg"></ion-icon>
                    <span>新會議</span>
                </button>
            </div>

            <nav class="flex-1 overflow-y-auto">
                <ul id="meetings-list">
                    <li class="p-4 text-center text-slate-500">載入中...</li>
                </ul>
            </nav>
        </aside>

        <!-- 右側主內容區 -->
        <main id="main-content" class="flex-1 h-full flex flex-col">
            
            <!-- 視圖切換器 -->
            <div id="view-toggle-container" class="p-2 bg-slate-100 border-b border-slate-200 flex-shrink-0">
                <div class="flex w-full max-w-sm mx-auto bg-slate-200 rounded-lg p-1">
                    <button class="tab-btn w-1/2 py-2 px-4 rounded-md text-sm font-semibold focus:outline-none" data-view="meetings">
                        <ion-icon name="document-text-outline" class="inline-block align-text-bottom mr-1"></ion-icon>
                        會議
                    </button>
                    <button class="tab-btn w-1/2 py-2 px-4 rounded-md text-sm font-semibold focus:outline-none" data-view="todos">
                         <ion-icon name="checkbox-outline" class="inline-block align-text-bottom mr-1"></ion-icon>
                        待辦事項
                    </button>
                </div>
            </div>

            <!-- 內容滾動區 -->
            <div class="flex-1 overflow-y-auto p-6 md:p-10">
                
                <!-- 會議表單 (用於新增/編輯) -->
                <section id="meeting-form" style="display: none;">
                    <form class="max-w-3xl mx-auto space-y-6">
                        <h2 id="form-title" class="text-3xl font-bold text-slate-800 mb-6">新增會議記錄</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="meeting-title" class="block text-sm font-medium text-slate-700 mb-1">會議標題</label>
                                <input type="text" id="meeting-title" name="meeting-title" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例如：Q4 產品策略會議">
                            </div>
                            <div>
                                <label for="meeting-recorder" class="block text-sm font-medium text-slate-700 mb-1">會議記錄人</label>
                                <input type="text" id="meeting-recorder" name="meeting-recorder" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例如：王小明">
                            </div>
                        </div>

                        <div>
                            <label for="meeting-attendees" class="block text-sm font-medium text-slate-700 mb-1">出席者 (用逗號分隔)</label>
                            <input type="text" id="meeting-attendees" name="meeting-attendees" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="例如：張三, 李四, 王五">
                        </div>

                        <div>
                            <label for="meeting-notes" class="block text-sm font-medium text-slate-700 mb-1">會議筆記</label>
                            <textarea id="meeting-notes" name="meeting-notes" rows="10" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="請在此輸入您的會議原始筆記..."></textarea>
                        </div>
                        
                        <!-- 按鈕區 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button type="submit" id="form-save-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2">
                                <ion-icon name="save-outline"></ion-icon>
                                <span>儲存並由 AI 分析</span>
                            </button>
                            <button type="button" id="form-ai-btn" class="w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg shadow text-lg transition duration-150 ease-in-out flex items-center justify-center gap-2 cursor-not-allowed" disabled>
                                <ion-icon name="sparkles-outline"></ion-icon>
                                <span>AI 分析 (需先儲存)</span>
                            </button>
                        </div>

                        <!-- AI 摘要 (表單內) -->
                        <div class="space-y-2">
                            <h3 class="text-xl font-semibold text-slate-700">AI 摘要</h3>
                            <div id="form-ai-summary" class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-lg min-h-[50px]">
                                <p class="text-slate-500 italic">點擊「AI 分析」按鈕以產生摘要。</p>
                            </div>
                        </div>
                        
                        <!-- AI 待辦事項 (表單內) -->
                        <div class="space-y-2">
                            <h3 class="text-xl font-semibold text-slate-700">AI 待辦事項</h3>
                            <div id="form-ai-action-items" class="space-y-3">
                                <p class="text-slate-500 italic">點擊「AI 分析」按鈕以提取待辦事項。</p>
                            </div>
                        </div>

                    </form>
                </section>
                
                <!-- 會議顯示 (用於檢視) -->
                <section id="meeting-display" class="max-w-4xl mx-auto space-y-8" style="display: none;">
                    <div>
                        <div class="flex flex-wrap justify-between items-start gap-4">
                            <div>
                                <h2 id="display-title" class="text-4xl font-bold text-slate-800"></h2>
                                <p id="display-date" class="text-lg text-slate-500 mt-2"></p>
                                <p id="display-recorder" class="text-md text-slate-600 mt-1"></p>
                                <p id="display-attendees" class="text-md text-slate-600 mt-1"></p>
                            </div>
                            <div class="flex-shrink-0 mt-2 flex gap-2">
                                <div id="edit-btn-container"></div>
                                <div id="download-btn-container"></div>
                            </div>
                        </div>
                        <div class="mt-4" id="delete-btn-container">
                            <!-- 刪除按鈕由 JS 填入 -->
                        </div>
                    </div>
                    
                    <div id="display-summary" class="bg-blue-50 border-l-4 border-blue-400 p-6 rounded-r-lg">
                        <!-- JS 載入 -->
                    </div>
                    
                    <div>
                        <h3 class="text-2xl font-semibold mb-4 text-slate-700">待辦事項 (進度追蹤)</h3>
                        <ul id="display-action-items-list" class="space-y-3">
                            <!-- JS 載入 -->
                        </ul>
                    </div>

                    <div id="display-notes" class="mt-10">
                        <!-- JS 載入 -->
                    </div>
                </section>
                
                <!-- 全域待辦事項視圖 -->
                <section id="todos-view" class="max-w-4xl mx-auto space-y-8" style="display: none;">
                    <h2 class="text-3xl font-bold text-slate-800 mb-6">所有待辦事項</h2>
                    <div id="global-todos-list" class="space-y-4">
                        <!-- 全域待辦事項列表由 JS 載入 -->
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- 載入中遮罩 -->
    <div id="loading-overlay" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="flex flex-col items-center bg-white p-8 rounded-lg shadow-xl">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="text-lg font-medium text-slate-700">處理中...</p>
        </div>
    </div>
    
    <!-- 錯誤訊息 Modal -->
    <div id="error-overlay" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <div class="flex items-center">
                <ion-icon name="warning-outline" class="text-3xl text-red-500 mr-3 flex-shrink-0"></ion-icon>
                <h3 class="text-xl font-semibold text-slate-800">發生錯誤</h3>
            </div>
            <p id="error-message-text" class="text-slate-600 mt-4 mb-6 break-words">發生未預期的錯誤。</p>
            <button id="close-error-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                關閉
            </button>
        </div>
    </div>

    <!-- 確認 Modal -->
    <div id="confirm-overlay" style="display: none;" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
            <div class="flex items-start">
                <ion-icon name="alert-circle-outline" class="text-3xl text-yellow-500 mr-3 flex-shrink-0"></ion-icon>
                <div class_E_S_S_ = "flex-1">
                    <h3 id="confirm-title" class="text-xl font-semibold text-slate-800">您確定嗎？</h3>
                    <p id="confirm-message-text" class="text-slate-600 mt-2 mb-6 break-words">此操作無法復原。</p>
                </div>
            </div>
            <div class="flex justify-end gap-3">
                <button id="cancel-confirm-btn" class="bg-gray-200 hover:bg-gray-300 text-slate-700 font-semibold py-2 px-4 rounded-lg">
                    取消
                </button>
                <button id="confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg">
                    確定
                </button>
            </div>
        </div>
    </div>

</body>
</html>
