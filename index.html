<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會議記錄系統 (團隊版)</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 使用 Inter 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- *** 新增：載入 Firebase SDK *** -->
    <!-- 建議使用最新版本，但 9.x 版是穩定的 -->
    <script type="module">
        // *** 步驟 6：將您在 Firebase 取得的 CONFIG 貼在這裡 ***
        // *** // *** 錯誤：auth/api-key-not-valid ***
        // *** 偵測到此錯誤！請務必將下方的範例 'firebaseConfig' 
        // *** 完整替換成您在 Firebase 官網取得的 *您自己的* 設定。
        // *** const firebaseConfig = {
            apiKey: "AIzaSyDpG3PvvYnTRxYFAXFsW-imf3X9pShxHh0",
  authDomain: "my-meeting-system.firebaseapp.com",
  projectId: "my-meeting-system",
  storageBucket: "my-meeting-system.firebasestorage.app",
  messagingSenderId: "856697883973",
  appId: "1:856697883973:web:5dc8f04c7ec9d8d583822c"
        };

        // ----------------------------------------------------
        // --- 下方的程式碼您不需要修改 ---
        // ----------------------------------------------------

        // 載入 Firebase 模組
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            onSnapshot, 
            addDoc, 
            updateDoc, 
            deleteDoc, 
            setDoc, 
            query, 
            orderBy, 
            serverTimestamp,
            writeBatch,
            getDoc  // *** 新增：載入 getDoc ***
        } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // --- 初始化 Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- 全域變數 ---
        let currentUserId = null;
        let currentUserEmail = null;
        
        let decisions = [];
        let editingDecisionIndex = null; 
        let actions = []; 
        let discussionLog = []; 
        let editingTopicId = null; 
        let meetings = []; 
        let editingMeetingId = null; 

        // Firebase 監聽器 (用於即時取消訂閱)
        let actionsUnsubscribe = null;
        let meetingsUnsubscribe = null;
        let draftUnsubscribe = null;
        
        // --- 獲取 DOM 元素 ---
        let mainContentContainer, loginOverlay, appContainer, userStatus, logoutBtn, loginBtn;
        let tabButtons, tabContents;
        let minutesForm, outputContainer, formattedMinutes, copyBtn, resetBtn, copySuccess, clipboardHelper, downloadBtn, generateMinutesBtn;
        let addDecisionBtn, decisionInput, decisionsList;
        let addActionBtn, actionTitle, actionNotes, actionOwner, actionDue, actionsList, actionError;
        let editModal, cancelEditBtn, saveActionBtn, modalActionId, modalActionTitle, modalActionNotes, modalActionOwner, modalActionDue, modalActionStatus, modalActionHistory, modalActionUpdate;
        let addLogBtn, logSpeaker, logStatement, logList, logError, logIsMotion;
        let replyModal, replyModalTitle, replyToStatement, replyTopicId, replyId, replySpeaker, replyStatement, cancelReplyBtn, saveReplyBtn;
        let viewPastMeetingsBtn, pastMeetingsModal, closePastModalBtn, pastMeetingsList, pastMeetingContent;
        let confirmModal, confirmTitle, confirmMessage, confirmCancelBtn, confirmOkBtn;
        
        // --- 顏色地圖 ---
        let personColorMap = new Map(); 
        const colorClasses = [ 
            'border-blue-400', 'border-green-400', 'border-purple-400', 
            'border-pink-400', 'border-yellow-500', 'border-red-400', 
            'border-indigo-400', 'border-teal-400'
        ];
        function getPersonColorClass(name) { 
            if (!name || name.trim() === '') return 'border-slate-300'; 
            const trimmedName = name.trim();
            if (personColorMap.has(trimmedName)) return personColorMap.get(trimmedName);
            const newColorClass = colorClasses[personColorMap.size % colorClasses.length];
            personColorMap.set(trimmedName, newColorClass);
            return newColorClass;
        }

        // --- 通用 Modal ---
        let confirmCallback = null; 
        function showConfirmModal(title, message, okText = "確認刪除", onConfirm) {
            confirmTitle.textContent = title;
            confirmMessage.textContent = message;
            confirmOkBtn.textContent = okText;
            confirmCallback = onConfirm; 
            confirmModal.classList.remove('hidden');
        }
        function hideConfirmModal() {
            confirmCallback = null;
            confirmModal.classList.add('hidden');
        }

        // --- 待辦事項 Modal 函式 ---
        function showModal() { 
            editModal.classList.remove('hidden'); 
        }
        function hideModal() { 
            editModal.classList.add('hidden'); 
            modalActionTitle.classList.remove('border-red-500');
            modalActionOwner.classList.remove('border-red-500');
        }

        // --- 草稿儲存 (Firebase 版) ---
        // Debounce 函數防止儲存過於頻繁
        let draftSaveTimeout;
        function saveDraft() {
            if (!currentUserId) return; // 未登入，不儲存
            if (draftSaveTimeout) clearTimeout(draftSaveTimeout);

            draftSaveTimeout = setTimeout(async () => {
                try {
                    const draft = {
                        title: document.getElementById('meeting-title').value,
                        date: document.getElementById('meeting-date').value,
                        location: document.getElementById('meeting-location').value,
                        recorder: document.getElementById('meeting-recorder').value,
                        attendees: document.getElementById('meeting-attendees').value,
                        agenda: document.getElementById('meeting-agenda').value,
                        decisions: decisions,
                        discussionLog: discussionLog,
                        updatedAt: serverTimestamp() // 標記時間
                    };
                    // 使用 setDoc (合併) 來儲存或更新
                    const draftRef = doc(db, 'drafts', currentUserId);
                    await setDoc(draftRef, draft, { merge: true });
                } catch (e) {
                    console.error("自動儲存草稿失敗:", e);
                }
            }, 1000); // 延遲 1 秒儲存
        }

        async function clearDraft() {
            if (!currentUserId) return;
            try {
                const draftRef = doc(db, 'drafts', currentUserId);
                await deleteDoc(draftRef);
                console.log("草稿已清除");
            } catch (e) {
                console.error("清除草稿失敗:", e);
            }
        }
        
        // --- 渲染函式 (與 localStorage 版相同) ---
        function renderDecisions() {
             decisionsList.innerHTML = '';
             if (decisions.length === 0) {
                 decisionsList.innerHTML = '<p class="text-slate-500 text-center">目前沒有重要決議。</p>';
                 return;
             }
            decisions.forEach((text, index) => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white p-3 rounded-lg border border-slate-200 shadow-sm';
                item.innerHTML = `
                    <span class="text-slate-800 flex-grow">${index + 1}. ${text}</span>
                    <div class="flex-shrink-0 ml-4 flex space-x-1">
                        <button type="button" data-index="${index}" class="edit-decision-btn text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="編輯">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </button>
                        <button type="button" data-index="${index}" class="remove-decision-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500" title="移除">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1zm4 0a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                decisionsList.appendChild(item);
            });
        }
        function renderDiscussionLog() {
            const listEl = document.querySelector('#tab-meeting #log-list');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (discussionLog.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 text-center">目前沒有發言記錄。</p>';
                return;
            }
            discussionLog.forEach((topic) => {
                const topicWrapper = document.createElement('div'); 
                topicWrapper.className = "mb-2";
                const topicItem = document.createElement('div');
                const colorClass = getPersonColorClass(topic.speaker);
                topicItem.className = `flex items-start justify-between bg-white p-3 rounded-lg border border-slate-200 border-l-4 ${colorClass} shadow-sm`;
                const motionTag = topic.isMotion ? '<span class="ml-2 bg-purple-100 text-purple-700 text-xs font-medium px-2 py-0.5 rounded-full">臨時動議</span>' : '';
                topicItem.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center">
                            <span class="font-semibold text-slate-900">${topic.speaker}:</span>
                            ${motionTag}
                        </div>
                        <p class="text-slate-800 ml-2" style="white-space: pre-wrap;">${topic.statement}</p>
                    </div>
                    <div class="flex-shrink-0 ml-4 flex space-x-1 items-center">
                        <button type="button" data-topic-id="${topic.id}" class="edit-log-btn text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="編輯話題">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                        </button>
                        <button type="button" data-topic-id="${topic.id}" class="remove-log-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500" title="移除話題">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1zm4 0a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                topicWrapper.appendChild(topicItem); 
                const repliesContainer = document.createElement('div');
                repliesContainer.className = 'ml-6 md:ml-10 mt-2 space-y-2 pl-4 border-l-2 border-slate-300';
                if (topic.replies && topic.replies.length > 0) {
                    topic.replies.forEach((reply) => {
                        const replyItem = document.createElement('div');
                        const replyColorClass = getPersonColorClass(reply.speaker);
                        replyItem.className = `flex items-start justify-between bg-white p-2 rounded-lg border border-slate-200 border-l-4 ${replyColorClass} shadow-sm`;
                        replyItem.innerHTML = `
                            <div class="flex-grow">
                                <span class="font-semibold text-slate-800">${reply.speaker}:</span>
                                <p class="text-slate-700 ml-2" style="white-space: pre-wrap;">${reply.statement}</p>
                            </div>
                            <div class="flex-shrink-0 ml-2 flex space-x-1 items-center">
                                <button type="button" data-topic-id="${topic.id}" data-reply-id="${reply.id}" class="add-decision-reply-btn text-yellow-500 hover:text-yellow-700 p-1.5 rounded-full hover:bg-yellow-100 focus:outline-none focus:ring-2 focus:ring-yellow-500" title="設為重要決議">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                </button>
                                <button type="button" data-topic-id="${topic.id}" data-reply-id="${reply.id}" class="edit-reply-btn text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="編輯回應">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                </button>
                                <button type="button" data-topic-id="${topic.id}" data-reply-id="${reply.id}" class="remove-reply-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500" title="移除回應">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1zm4 0a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        `;
                        repliesContainer.appendChild(replyItem);
                    });
                }
                const addReplyBtnWrapper = document.createElement('div');
                addReplyBtnWrapper.className = 'mt-2';
                addReplyBtnWrapper.innerHTML = `<button type="button" data-topic-id="${topic.id}" class="add-reply-btn text-sm text-blue-600 font-medium hover:text-blue-800 p-1 rounded-lg hover:bg-blue-100">+ 新增回應</button>`;
                repliesContainer.appendChild(addReplyBtnWrapper);
                topicWrapper.appendChild(repliesContainer); 
                listEl.appendChild(topicWrapper); 
            });
        }
        function renderActions() {
            const listEl = document.querySelector('#tab-actions #actions-list');
            if (!listEl) return; 
            listEl.innerHTML = '';
            if (actions.length === 0) {
                listEl.innerHTML = '<p class="text-slate-500 text-center">目前沒有待辦事項。</p>';
                return;
            }
            const todayString = new Date().toISOString().split('T')[0];
            const actionsByOwner = actions.reduce((acc, action) => {
                const owner = action.owner.trim() || '未指派';
                if (!acc[owner]) acc[owner] = [];
                acc[owner].push(action);
                return acc;
            }, {});
            const sortedOwners = Object.keys(actionsByOwner).sort();
            sortedOwners.forEach(owner => {
                const groupContainer = document.createElement('div');
                const colorClass = getPersonColorClass(owner); 
                groupContainer.className = `rounded-lg border ${colorClass} border-l-4 bg-white mb-4 shadow-sm`;
                const header = document.createElement('div');
                header.className = 'p-3 border-b border-slate-200 bg-slate-50 rounded-t-lg';
                header.innerHTML = `<h3 class="font-bold text-lg text-slate-800">${owner}</h3>`;
                groupContainer.appendChild(header);
                const tasksList = document.createElement('div');
                tasksList.className = 'p-3 space-y-3'; 
                groupContainer.appendChild(tasksList);
                const tasks = actionsByOwner[owner];
                const statusOrder = { 'pending': 1, 'in_progress': 2, 'done': 3 };
                tasks.sort((a, b) => {
                    const statusA = statusOrder[a.status] || 4;
                    const statusB = statusOrder[b.status] || 4;
                    if (statusA !== statusB) return statusA - statusB;
                    const dueA = a.due || '9999-12-31';
                    const dueB = b.due || '9999-12-31';
                    return new Date(dueA) - new Date(dueB);
                });
                tasks.forEach(action => {
                    const item = document.createElement('div');
                    const isDone = action.status === 'done';
                    const latestUpdate = (action.progressUpdates && action.progressUpdates.length > 0) 
                        ? action.progressUpdates[action.progressUpdates.length - 1] 
                        : null; 
                    let statusLabel = '';
                    switch (action.status) {
                        case 'pending': statusLabel = '<span class="text-xs font-medium bg-slate-200 text-slate-700 px-2 py-0.5 rounded-full">待處理</span>'; break;
                        case 'in_progress': statusLabel = '<span class="text-xs font-medium bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded-full">進行中</span>'; break;
                        case 'done': statusLabel = '<span class="text-xs font-medium bg-green-200 text-green-800 px-2 py-0.5 rounded-full">已完成</span>'; break;
                    }
                    let overdueLabel = '';
                    if (action.due && todayString > action.due && action.status !== 'done') {
                        overdueLabel = ' <span class="font-bold text-red-600">(已逾期)</span>';
                    }
                    item.className = `bg-white p-3 rounded-lg border border-slate-200 shadow-sm ${isDone ? 'opacity-60' : ''}`;
                    // *** 修改：從 action.id 改為 action.docId ***
                    item.innerHTML = `
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-2">
                                    ${statusLabel}
                                    <span class="font-medium ${isDone ? 'text-slate-600 line-through' : 'text-slate-900'}">${action.title}</span>
                                </div>
                                <span class="text-sm text-slate-600 block ml-1">
                                    ${action.due ? `截止日期：${action.due}` : ''}${overdueLabel}
                                </span>
                                ${action.notes ? `<p class="text-sm text-slate-600 mt-2 ml-1" style="white-space: pre-wrap;">${action.notes}</p>` : ''}
                                ${latestUpdate ? `
                                <div class="mt-2 ml-1">
                                    <span class="text-sm font-medium text-slate-700">最新進度 (${latestUpdate.date}):</span>
                                    <span class="block font-semibold text-blue-700 mt-1">${latestUpdate.update}</span>
                                </div>` : ''}
                            </div>
                            <div class="flex-shrink-0 flex items-center space-x-1">
                                <button type="button" data-id="${action.docId}" class="open-edit-modal-btn text-blue-600 hover:text-blue-800 p-1.5 rounded-full hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500" title="編輯/更新">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                </button>
                                <button type="button" data-id="${action.docId}" class="remove-action-btn text-red-500 hover:text-red-700 p-1.5 rounded-full hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-500" title="移除">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 6h6v10H7V6zm2 2a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1zm4 0a1 1 0 011 1v6a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>`;
                    tasksList.appendChild(item);
                });
                listEl.appendChild(groupContainer);
            });
        }
        function renderPastMeetingsList() {
            pastMeetingsList.innerHTML = '';
            if (meetings.length === 0) {
                pastMeetingsList.innerHTML = '<p class="text-slate-500">沒有儲存的會議...</p>';
                return;
            }
            meetings.forEach(meeting => {
                const item = document.createElement('div');
                item.className = 'w-full text-left p-3 rounded-lg hover:bg-blue-100 data-item'; 
                item.dataset.id = meeting.docId; // *** 修改：使用 docId ***
                item.innerHTML = `
                    <div class="view-past-meeting-content cursor-pointer flex-grow pr-4" style="min-width: 0;"> 
                        <span class="block font-semibold text-blue-800 truncate-title" title="${meeting.title}">${meeting.title}</span>
                        <span class="block text-sm text-slate-600 pointer-events-none">${meeting.date}</span>
                    </div>
                    <div class="flex-shrink-0 mt-3 space-x-2">
                        <button type="button" data-id="${meeting.docId}" class="edit-past-meeting-btn bg-blue-600 text-white py-1 px-3 rounded-lg text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            載入編輯
                        </button>
                        <button type="button" data-id="${meeting.docId}" class="delete-past-meeting-btn bg-red-600 text-white py-1 px-3 rounded-lg text-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                            刪除
                        </button>
                    </div>
                `;
                pastMeetingsList.appendChild(item);
            });
        }
        
        // --- HTML 產生器 (與 localStorage 版相同) ---
        function generateMeetingHtml(data) {
            let htmlOutput = `<h1 class="text-2xl font-bold text-center mb-6">${data.title}</h1>`;
            htmlOutput += `<div class="grid grid-cols-2 gap-x-8 gap-y-2 mb-6 text-sm"><p><strong>會議日期：</strong> ${data.date}</p><p><strong>會議地點：</strong> ${data.location}</p><p><strong>記錄人：</strong> ${data.recorder}</p></div>`;
            htmlOutput += `<h2>出席人員</h2><p>${(data.attendees || '未填寫').replace(/\n/g, '<br>')}</p>`;
            htmlOutput += `<h2>會議目的 / 議程</h2><p>${(data.agenda || '未填寫').replace(/\n/g, '<br>')}</p>`;
            htmlOutput += '<h2>重要決議</h2>';
            if (data.decisions && data.decisions.length > 0) {
                htmlOutput += '<ul>';
                data.decisions.forEach(text => { htmlOutput += `<li>${text}</li>`; });
                htmlOutput += '</ul>';
            } else { htmlOutput += '<p>無</p>'; }
            const actionItems = data.actions || [];
            if (actionItems.length > 0) {
                htmlOutput += '<h2>待辦事項</h2>';
                const getStatusLabel = (status) => {
                    switch (status) {
                        case 'pending': return ' [待處理]';
                        case 'in_progress': return ' [進行中]';
                        case 'done': return ' [已完成]';
                        default: return '';
                    }
                };
                const pendingActions = actionItems.filter(a => a.status !== 'done');
                const doneActions = actionItems.filter(a => a.status === 'done');
                if (pendingActions.length > 0) {
                    htmlOutput += '<h3>待追蹤事項</h3><ul>';
                    pendingActions.forEach(action => {
                        htmlOutput += `<li><strong>${getStatusLabel(action.status)} [${action.owner}]</strong> ${action.title} ${action.due ? `(截止日期: ${action.due})` : ''}`;
                        if (action.notes) htmlOutput += `<p style="margin-top: 4px; margin-left: 20px; font-style: italic; color: #555;">${action.notes.replace(/\n/g, '<br>')}</p>`;
                        if (action.progressUpdates) { 
                            htmlOutput += '<ul class="action-item-history">'; 
                            action.progressUpdates.forEach(up => { htmlOutput += `<li><strong>${up.date}:</strong> ${up.update}</li>`; });
                            htmlOutput += '</ul>';
                        }
                        htmlOutput += '</li>';
                    });
                    htmlOutput += '</ul>';
                }
                if (doneActions.length > 0) {
                    htmlOutput += '<h3>已完成事項</h3><ul>';
                    doneActions.forEach(action => {
                        htmlOutput += `<li><strong>${getStatusLabel(action.status)} [${action.owner}]</strong> ${action.title} ${action.due ? `(截止日期: ${action.due})` : ''}`;
                        if (action.notes) htmlOutput += `<p style="margin-top: 4px; margin-left: 20px; font-style: italic; color: #555;">${action.notes.replace(/\n/g, '<br>')}</p>`;
                        if (action.progressUpdates) { 
                            htmlOutput += '<ul class="action-item-history">'; 
                            action.progressUpdates.forEach(up => { htmlOutput += `<li><strong>${up.date}:</strong> ${up.update}</li>`; });
                            htmlOutput += '</ul>';
                        }
                        htmlOutput += '</ul></li>';
                    });
                    htmlOutput += '</ul>';
                }
            } else if (data.actions) { htmlOutput += '<h2>待辦事項</h2><p>無</p>'; }
            htmlOutput += '<h2>發言記錄 (討論串)</h2>';
            if (data.discussionLog && data.discussionLog.length > 0) {
                htmlOutput += '<ul>';
                data.discussionLog.forEach(topic => {
                    const motionTag = topic.isMotion ? ' <strong>(臨時動議)</strong>' : '';
                    htmlOutput += `<li><strong>${topic.speaker}${motionTag}:</strong> <p style="margin: 0; display: inline;">${topic.statement.replace(/\n/g, '<br>')}</p>`; 
                    if (topic.replies && topic.replies.length > 0) {
                        htmlOutput += '<ul style="list-style-type: circle; margin-left: 20px; margin-top: 5px;">';
                        topic.replies.forEach(reply => {
                            htmlOutput += `<li><strong>${reply.speaker}:</strong> <p style="margin: 0; display: inline;">${reply.statement.replace(/\n/g, '<br>')}</p></li>`;
                        });
                        htmlOutput += '</ul>';
                    }
                    htmlOutput += '</li>';
                });
                htmlOutput += '</ul>';
            } else { htmlOutput += '<p>無</p>'; }
            htmlOutput += '<h2>臨時動議</h2>';
            const motions = data.discussionLog ? data.discussionLog.filter(log => log.isMotion) : [];
            if (motions.length > 0) {
                htmlOutput += '<ul>';
                motions.forEach(text => { htmlOutput += `<li><strong>[${text.speaker}]</strong> ${text.statement}</li>`; }); 
                htmlOutput += '</ul>';
            } else { htmlOutput += '<p>無</p>'; }
            return htmlOutput;
        }
        function generatePlainTextOutput() {
            const title = document.getElementById('meeting-title').value;
            const date = document.getElementById('meeting-date').value;
            const location = document.getElementById('meeting-location').value;
            const recorder = document.getElementById('meeting-recorder').value;
            const attendees = document.getElementById('meeting-attendees').value;
            const agenda = document.getElementById('meeting-agenda').value;
            let textOutput = `【${title}】\n\n`;
            textOutput += `會議日期：${date}\n會議地點：${location}\n記錄人：${recorder}\n\n`;
            textOutput += `--- 出席人員 ---\n${attendees || '未填寫'}\n\n`;
            textOutput += `--- 會議目的 / 議程 ---\n${agenda || '未填寫'}\n\n`;
            textOutput += '--- 重要決議 ---\n';
            if (decisions.length > 0) {
                decisions.forEach((text, i) => { textOutput += `${i + 1}. ${text}\n`; });
            } else { textOutput += '無\n'; }
            
            textOutput += '\n--- 發言記錄 (討論串) ---\n';
            if (discussionLog.length > 0) {
                discussionLog.forEach((topic) => { 
                    const motionTag = topic.isMotion ? '(臨時動議) ' : '';
                    textOutput += `[${topic.speaker}]: ${motionTag}${topic.statement}\n`; 
                    if (topic.replies && topic.replies.length > 0) {
                        topic.replies.forEach(reply => {
                            textOutput += `  - [${reply.speaker}]: ${reply.statement}\n`; 
                        });
                    }
                });
            } else { textOutput += '無\n'; }
            textOutput += '\n'; 
            
            textOutput += '--- 臨時動議 ---\n';
            const motions = discussionLog ? discussionLog.filter(log => log.isMotion) : [];
            if (motions.length > 0) {
                motions.forEach((text, i) => { textOutput += `${i + 1}. [${text.speaker}]: ${text.statement}\n`; });
            } else { textOutput += '無\n'; }
            textOutput += '\n';
            return textOutput;
        }
        function resetLogForm() {
            editingTopicId = null;
            addLogBtn.textContent = '新增話題';
            addLogBtn.classList.replace('bg-green-600', 'bg-blue-600');
            addLogBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
            logSpeaker.value = '';
            logStatement.value = '';
            logIsMotion.checked = false;
        }


        // --- *** Firebase 資料監聽 *** ---

        // 監聽「待辦事項」集合
        function setupActionListeners() {
            if (actionsUnsubscribe) actionsUnsubscribe(); // 取消舊的監聽
            // *** 修改：確保查詢是針對目前登入者 ***
            // *** 假設待辦事項是全團隊共享，所以查詢 actions 集合 ***
            const actionsQuery = query(collection(db, 'actions'), orderBy('createdAt', 'desc'));
            actionsUnsubscribe = onSnapshot(actionsQuery, (snapshot) => {
                actions = [];
                snapshot.forEach((doc) => {
                    actions.push({ ...doc.data(), docId: doc.id }); // *** 儲存 docId ***
                });
                renderActions();
            }, (error) => console.error("監聽待辦事項失敗:", error));
        }

        // 監聽「會議」集合
        function setupMeetingListeners() {
            if (meetingsUnsubscribe) meetingsUnsubscribe();
             // *** 假設會議是全團隊共享 ***
            const meetingsQuery = query(collection(db, 'meetings'), orderBy('date', 'desc'));
            meetingsUnsubscribe = onSnapshot(meetingsQuery, (snapshot) => {
                meetings = [];
                snapshot.forEach((doc) => {
                    meetings.push({ ...doc.data(), docId: doc.id }); // *** 儲存 docId ***
                });
                // 注意：這裡不需要 render，只有在打開 Modal 時才 render
                // 如果 Modal 是打開的，則重新渲染
                if (!pastMeetingsModal.classList.contains('hidden')) {
                    renderPastMeetingsList();
                }
            }, (error) => console.error("監聽會議失敗:", error));
        }

        // 監聽「個人草稿」文件
        function setupDraftListener(userId) {
            if (draftUnsubscribe) draftUnsubscribe();
            const draftRef = doc(db, 'drafts', userId);
            draftUnsubscribe = onSnapshot(draftRef, (doc) => {
                if (doc.exists()) {
                    const draft = doc.data();
                    // 只有在不是編輯會議的狀態下才載入草稿
                    if (editingMeetingId === null) {
                        document.getElementById('meeting-title').value = draft.title || '';
                        document.getElementById('meeting-date').value = draft.date || new Date().toISOString().split('T')[0];
                        document.getElementById('meeting-location').value = draft.location || '';
                        document.getElementById('meeting-recorder').value = draft.recorder || '';
                        document.getElementById('meeting-attendees').value = draft.attendees || '';
                        document.getElementById('meeting-agenda').value = draft.agenda || '';
                        decisions = draft.decisions || [];
                        discussionLog = draft.discussionLog || [];
                        renderDecisions();
                        renderDiscussionLog();
                    }
                } else {
                    // 文件不存在，清空本地陣列 (如果不是在編輯會議)
                    if (editingMeetingId === null) {
                        resetFormOnly();
                    }
                }
            }, (error) => console.error("監聽草稿失敗:", error));
        }

        // --- Firebase 事件處理 ---
        
        // 頁面載入完成時
        document.addEventListener('DOMContentLoaded', () => {
            // 獲取所有 DOM 元素 (因為 script type=module)
            mainContentContainer = document.getElementById('minutes-form');
            loginOverlay = document.getElementById('login-overlay');
            appContainer = document.getElementById('app-container');
            userStatus = document.getElementById('user-status');
            logoutBtn = document.getElementById('logout-btn');
            loginBtn = document.getElementById('login-btn');
            tabButtons = document.querySelectorAll('.tab-btn');
            tabContents = document.querySelectorAll('.tab-content');
            outputContainer = document.getElementById('output-container');
            formattedMinutes = document.getElementById('formatted-minutes');
            copyBtn = document.getElementById('copy-btn');
            resetBtn = document.getElementById('reset-btn');
            copySuccess = document.getElementById('copy-success');
            clipboardHelper = document.getElementById('clipboard-helper');
            downloadBtn = document.getElementById('download-btn');
            generateMinutesBtn = document.getElementById('generate-minutes-btn');
            addDecisionBtn = document.getElementById('add-decision-btn');
            decisionInput = document.getElementById('decision-input');
            decisionsList = document.getElementById('decisions-list');
            addActionBtn = document.getElementById('add-action-btn');
            actionTitle = document.getElementById('action-title');
            actionNotes = document.getElementById('action-notes');
            actionOwner = document.getElementById('action-owner');
            actionDue = document.getElementById('action-due');
            actionsList = document.getElementById('actions-list');
            actionError = document.getElementById('action-error');
            editModal = document.getElementById('edit-modal');
            cancelEditBtn = document.getElementById('cancel-edit-btn');
            saveActionBtn = document.getElementById('save-action-btn');
            modalActionId = document.getElementById('edit-action-id');
            modalActionTitle = document.getElementById('modal-action-title');
            modalActionNotes = document.getElementById('modal-action-notes');
            modalActionOwner = document.getElementById('modal-action-owner');
            modalActionDue = document.getElementById('modal-action-due');
            modalActionStatus = document.getElementById('modal-action-status');
            modalActionHistory = document.getElementById('modal-action-history');
            modalActionUpdate = document.getElementById('modal-action-update');
            addLogBtn = document.getElementById('add-log-btn');
            logSpeaker = document.getElementById('log-speaker');
            logStatement = document.getElementById('log-statement');
            logList = document.getElementById('log-list');
            logError = document.getElementById('log-error');
            logIsMotion = document.getElementById('log-is-motion');
            replyModal = document.getElementById('reply-modal');
            replyModalTitle = document.getElementById('reply-modal-title');
            replyToStatement = document.getElementById('reply-to-statement');
            replyTopicId = document.getElementById('reply-topic-id');
            replyId = document.getElementById('reply-id');
            replySpeaker = document.getElementById('reply-speaker');
            replyStatement = document.getElementById('reply-statement');
            cancelReplyBtn = document.getElementById('cancel-reply-btn');
            saveReplyBtn = document.getElementById('save-reply-btn');
            viewPastMeetingsBtn = document.getElementById('view-past-meetings-btn');
            pastMeetingsModal = document.getElementById('past-meetings-modal');
            closePastModalBtn = document.getElementById('close-past-modal-btn');
            pastMeetingsList = document.getElementById('past-meetings-list');
            pastMeetingContent = document.getElementById('past-meeting-content');
            confirmModal = document.getElementById('confirm-modal');
            confirmTitle = document.getElementById('confirm-title');
            confirmMessage = document.getElementById('confirm-message');
            confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            confirmOkBtn = document.getElementById('confirm-ok-btn');

            // --- 綁定通用事件 ---
            confirmOkBtn.addEventListener('click', () => {
                if (typeof confirmCallback === 'function') confirmCallback(); 
                hideConfirmModal();
            });
            confirmCancelBtn.addEventListener('click', hideConfirmModal);

            // --- 綁定 Firebase 登入事件 ---
            loginBtn.addEventListener('click', async () => {
                try {
                    await signInWithPopup(auth, provider);
                    // 狀態變更將由 onAuthStateChanged 處理
                } catch (error) {
                    console.error("登入失敗:", error);
                }
            });

            logoutBtn.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    // 狀態變更將由 onAuthStateChanged 處理
                } catch (error) {
                    console.error("登出失敗:", error);
                }
            });

            // --- 核心：監聽登入狀態 ---
            onAuthStateChanged(auth, async (user) => { // *** 設為 async ***
                if (user) {
                    // --- 使用者已登入，檢查權限 ---
                    currentUserId = user.uid;
                    // *** 修改：強制轉為小寫 ***
                    currentUserEmail = user.email.toLowerCase();

                    // *** 新增：檢查 Email 白名單 ***
                    try {
                        // *** 修改：使用小寫的 Email 去查詢 ***
                        const memberRef = doc(db, 'team_members', currentUserEmail);
                        const memberDoc = await getDoc(memberRef);

                        if (memberDoc.exists()) {
                            // --- 權限通過 ---
                            appContainer.classList.remove('hidden');
                            loginOverlay.classList.add('hidden');
                            userStatus.textContent = `登入身分：${user.email}`; // 顯示原始 Email
                            logoutBtn.classList.remove('hidden');

                            // 啟動所有 Firebase 監聽器
                            setupActionListeners();
                            setupMeetingListeners();
                            setupDraftListener(currentUserId);
                        } else {
                            // --- 權限不足 ---
                            // *** 修改：不再強制登出 ***
                            // await signOut(auth); 
                            const loginErrorEl = document.getElementById('login-message');
                            loginErrorEl.textContent = `您的帳號 (${user.email}) 未被授權存取此系統。請聯繫管理員。`;
                            loginErrorEl.classList.add('text-red-600', 'font-bold');
                        }
                    } catch (error) {
                        console.error("檢查權限失敗:", error);
                        // *** 修改：不再強制登出 ***
                        // await signOut(auth); 
                        const loginErrorEl = document.getElementById('login-message');
                        loginErrorEl.textContent = `檢查權限時發生錯誤，請稍後再試。`;
                        loginErrorEl.classList.add('text-red-600', 'font-bold');
                    }
                    
                } else {
                    // --- 使用者已登出 ---
                    currentUserId = null;
                    currentUserEmail = null;

                    // 顯示登入畫面，隱藏應用程式
                    appContainer.classList.add('hidden');
                    loginOverlay.classList.remove('hidden');
                    userStatus.textContent = '';
                    logoutBtn.classList.add('hidden');

                    // 重設登入錯誤訊息
                    const loginErrorEl = document.getElementById('login-message'); // *** 修改：使用 ID ***
                    loginErrorEl.textContent = '這是一個團隊共享版，請登入您的 Google 帳號以開始使用。';
                    loginErrorEl.classList.remove('text-red-600', 'font-bold');


                    // 取消所有監聽
                    if (actionsUnsubscribe) actionsUnsubscribe();
                    if (meetingsUnsubscribe) meetingsUnsubscribe();
                    if (draftUnsubscribe) draftUnsubscribe();

                    // 清空本地資料
                    actions = []; meetings = []; decisions = []; discussionLog = [];
                    renderActions(); renderDecisions(); renderDiscussionLog();
                    resetFormOnly();
                }
            });

            // --- 綁定分頁事件 ---
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.remove('bg-blue-50', 'text-blue-600', 'font-semibold');
                        btn.classList.add('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');
                    });
                    button.classList.add('active');
                    button.classList.add('bg-blue-50', 'text-blue-600', 'font-semibold');
                    button.classList.remove('text-slate-500', 'hover:text-slate-700', 'hover:border-slate-300');

                    const targetTab = button.dataset.tab;
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(targetTab).classList.add('active');
                });
            });

            // --- 綁定待辦事項 (Firebase 版) ---
            document.querySelector('#tab-actions #add-action-btn').addEventListener('click', async () => {
                const titleEl = document.querySelector('#tab-actions #action-title');
                const notesEl = document.querySelector('#tab-actions #action-notes');
                const ownerEl = document.querySelector('#tab-actions #action-owner');
                const dueEl = document.querySelector('#tab-actions #action-due');
                const errorEl = document.querySelector('#tab-actions #action-error');
                const title = titleEl.value.trim();
                const notes = notesEl.value.trim();
                const owner = ownerEl.value.trim();
                const due = dueEl.value.trim();
                
                if (title && owner) {
                    const today = new Date().toISOString().split('T')[0];
                    const newAction = {
                        title, notes, owner, due,
                        status: 'pending', 
                        progressUpdates: [{ date: today, update: "任務已建立" }],
                        createdAt: serverTimestamp() // 用於排序
                    };
                    try {
                        await addDoc(collection(db, 'actions'), newAction);
                        // 清空欄位 (成功後)
                        titleEl.value = ''; notesEl.value = ''; ownerEl.value = ''; dueEl.value = '';
                        errorEl.classList.add('hidden'); 
                        titleEl.focus(); 
                    } catch (e) {
                        console.error("新增待辦失敗:", e);
                        errorEl.textContent = "新增失敗，請稍後再試。";
                        errorEl.classList.remove('hidden');
                    }
                } else {
                    errorEl.textContent = "請至少填寫「主標題」和「負責人」";
                    errorEl.classList.remove('hidden'); 
                }
            });
            saveActionBtn.addEventListener('click', async () => {
                modalActionTitle.classList.remove('border-red-500');
                modalActionOwner.classList.remove('border-red-500');
                const id = modalActionId.value;
                const newTitle = modalActionTitle.value.trim();
                const newNotes = modalActionNotes.value.trim();
                const newOwner = modalActionOwner.value.trim();
                const newDue = modalActionDue.value;
                const newStatus = modalActionStatus.value;
                const newUpdateText = modalActionUpdate.value.trim(); 
                if (!newTitle || !newOwner) {
                    if (!newTitle) modalActionTitle.classList.add('border-red-500');
                    if (!newOwner) modalActionOwner.classList.add('border-red-500');
                    return; 
                }
                const actionRef = doc(db, 'actions', id);
                const actionIndex = actions.findIndex(a => a.docId === id);
                if (actionIndex === -1) return; // 找不到
                
                const action = actions[actionIndex];
                const oldStatus = action.status; 
                const today = new Date().toISOString().split('T')[0];
                let newProgressUpdates = [...(action.progressUpdates || [])]; // 複製舊的

                if (oldStatus !== newStatus) {
                    let statusText = '';
                    switch (newStatus) {
                        case 'pending': statusText = '待處理'; break;
                        case 'in_progress': statusText = '進行中'; break;
                        case 'done': statusText = '已完成'; break;
                    }
                    newProgressUpdates.push({ date: today, update: `狀態更新為 ${statusText}` });
                }
                if (newUpdateText) {
                    newProgressUpdates.push({ date: today, update: newUpdateText });
                }
                
                try {
                    await updateDoc(actionRef, {
                        title: newTitle,
                        notes: newNotes,
                        owner: newOwner,
                        due: newDue,
                        status: newStatus,
                        progressUpdates: newProgressUpdates
                    });
                    hideModal();
                } catch (e) {
                    console.error("更新待辦失敗:", e);
                }
            });
            cancelEditBtn.addEventListener('click', hideModal);
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) hideModal();
            });

            // --- 綁定決議事件 (Firebase 版) ---
            addDecisionBtn.addEventListener('click', () => {
                const decisionText = decisionInput.value.trim();
                if (!decisionText) return; 
                if (editingDecisionIndex !== null) {
                    decisions[editingDecisionIndex] = decisionText;
                    editingDecisionIndex = null; 
                    addDecisionBtn.textContent = '新增決議';
                    addDecisionBtn.classList.replace('bg-green-600', 'bg-blue-600');
                    addDecisionBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                } else {
                    decisions.push(decisionText);
                }
                renderDecisions();
                saveDraft(); // *** 儲存草稿 ***
                decisionInput.value = '';
                decisionInput.focus();
            });
            
            // --- 綁定發言記錄 (Firebase 版) ---
            addLogBtn.addEventListener('click', () => {
                const speaker = logSpeaker.value.trim();
                const statement = logStatement.value.trim();
                const isMotion = logIsMotion.checked; 
                if (!speaker || !statement) {
                    logError.classList.remove('hidden'); return;
                }
                logError.classList.add('hidden');
                if (editingTopicId) {
                    const topic = discussionLog.find(t => t.id === editingTopicId);
                    if (topic) {
                        topic.speaker = speaker;
                        topic.statement = statement;
                        topic.isMotion = isMotion; 
                    }
                    resetLogForm(); 
                } else {
                    discussionLog.push({ 
                        id: crypto.randomUUID(),
                        speaker, statement, isMotion, 
                        replies: [] 
                    });
                }
                renderDiscussionLog();
                saveDraft(); // *** 儲存草稿 ***
                logSpeaker.value = ''; 
                logStatement.value = '';
                logIsMotion.checked = false; 
                logSpeaker.focus(); 
            });
            saveReplyBtn.addEventListener('click', () => {
                const topicId = replyTopicId.value;
                const idToSave = replyId.value; 
                const speaker = replySpeaker.value.trim();
                const statement = replyStatement.value.trim();
                if (!speaker || !statement) return;
                const topic = discussionLog.find(t => t.id === topicId);
                if (!topic) return;
                if (idToSave) {
                    const reply = topic.replies.find(r => r.id === idToSave);
                    if (reply) {
                        reply.speaker = speaker;
                        reply.statement = statement;
                    }
                } else {
                    topic.replies.push({
                        id: crypto.randomUUID(),
                        speaker,
                        statement
                    });
                }
                renderDiscussionLog();
                hideReplyModal();
                saveDraft(); // *** 儲存草稿 ***
            });
            cancelReplyBtn.addEventListener('click', hideReplyModal);
            replyModal.addEventListener('click', (e) => {
                if(e.target === replyModal) hideReplyModal();
            });

            // --- 綁定主事件委派 (Firebase 版) ---
            mainContentContainer.addEventListener('click', (e) => {
                const removeDecisionBtn = e.target.closest('.remove-decision-btn');
                const editDecisionBtn = e.target.closest('.edit-decision-btn');
                const removeActionBtn = e.target.closest('.remove-action-btn');
                const openEditModalBtn = e.target.closest('.open-edit-modal-btn');
                const removeLogBtn = e.target.closest('.remove-log-btn');
                const editLogBtn = e.target.closest('.edit-log-btn');
                const addReplyBtn = e.target.closest('.add-reply-btn'); 
                const editReplyBtn = e.target.closest('.edit-reply-btn'); 
                const removeReplyBtn = e.target.closest('.remove-reply-btn'); 
                const addDecisionReplyBtn = e.target.closest('.add-decision-reply-btn'); 

                // 決議
                if (removeDecisionBtn) {
                    const index = parseInt(removeDecisionBtn.dataset.index, 10);
                    showConfirmModal('刪除決議', `您確定要刪除第 ${index + 1} 項決議嗎？`, "確認刪除", () => {
                        decisions.splice(index, 1);
                        renderDecisions();
                        if (editingDecisionIndex === index) {
                            editingDecisionIndex = null;
                            addDecisionBtn.textContent = '新增決議';
                            addDecisionBtn.classList.replace('bg-green-600', 'bg-blue-600');
                            addDecisionBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                            decisionInput.value = '';
                        }
                        saveDraft(); // *** 儲存草稿 ***
                    }); return;
                }
                if (editDecisionBtn) {
                    const index = parseInt(editDecisionBtn.dataset.index, 10);
                    decisionInput.value = decisions[index];
                    addDecisionBtn.textContent = '更新決議'; 
                    addDecisionBtn.classList.replace('bg-blue-600', 'bg-green-600'); 
                    addDecisionBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                    editingDecisionIndex = index; 
                    decisionInput.focus(); return; 
                }
                // 待辦
                if (removeActionBtn) {
                    const id = removeActionBtn.dataset.id;
                    const action = actions.find(a => a.docId === id);
                    if (!action) return;
                    showConfirmModal('刪除待辦事項', `您確定要刪除「${action.title}」這項待辦嗎？`, "確認刪除", async () => {
                        try {
                            await deleteDoc(doc(db, 'actions', id));
                            // onSnapshot 會自動觸發 render
                        } catch (e) {
                            console.error("刪除待辦失敗:", e);
                        }
                    }); return;
                }
                if (openEditModalBtn) {
                    const id = openEditModalBtn.dataset.id;
                    const action = actions.find(a => a.docId === id);
                    if (action) { 
                        // *** 修正：傳入 action 而非 action.id ***
                        populateEditModal(action); 
                        showModal(); 
                    }
                    return; 
                }
                // 刪除「話題」
                if (removeLogBtn) {
                    const topicId = removeLogBtn.dataset.topicId;
                    const topicIndex = discussionLog.findIndex(t => t.id === topicId);
                    if (topicIndex === -1) return;
                    const replyCount = discussionLog[topicIndex].replies.length;
                    showConfirmModal('刪除話題', `您確定要刪除這個話題嗎？此話題下的 ${replyCount} 筆回應將一併被刪除。`, "確認刪除", () => {
                        discussionLog.splice(topicIndex, 1);
                        renderDiscussionLog();
                        if (editingTopicId === topicId) resetLogForm();
                        saveDraft(); // *** 儲存草稿 ***
                    }); return; 
                }
                // 編輯「話題」
                if (editLogBtn) {
                    const topicId = editLogBtn.dataset.topicId;
                    const topic = discussionLog.find(t => t.id === topicId);
                    if (!topic) return;
                    editingTopicId = topicId; 
                    addLogBtn.textContent = '更新話題';
                    addLogBtn.classList.replace('bg-blue-600', 'bg-green-600'); 
                    addLogBtn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                    logSpeaker.value = topic.speaker;
                    logStatement.value = topic.statement;
                    logIsMotion.checked = topic.isMotion;
                    logSpeaker.focus(); return; 
                }
                // 開啟「新增回應」Modal
                if (addReplyBtn) {
                    const topicId = addReplyBtn.dataset.topicId;
                    showReplyModal(topicId); return;
                }
                // 開啟「編輯回應」Modal
                if (editReplyBtn) {
                    const topicId = editReplyBtn.dataset.topicId;
                    const replyId = editReplyBtn.dataset.replyId;
                    const topic = discussionLog.find(t => t.id === topicId);
                    if (topic) {
                        const reply = topic.replies.find(r => r.id === replyId);
                        if (reply) showReplyModal(topicId, reply);
                    } return;
                }
                // 刪除「回應」
                if (removeReplyBtn) {
                    const topicId = removeReplyBtn.dataset.topicId;
                    const replyId = removeReplyBtn.dataset.replyId;
                    showConfirmModal('刪除回應', `您確定要刪除這筆回應嗎？`, "確認刪除", () => {
                        const topic = discussionLog.find(t => t.id === topicId);
                        if (topic) {
                            topic.replies = topic.replies.filter(r => r.id !== replyId);
                            renderDiscussionLog();
                            saveDraft(); // *** 儲存草稿 ***
                        }
                    }); return;
                }
                // 將回應設為決議
                if (addDecisionReplyBtn) {
                    const topicId = addDecisionReplyBtn.dataset.topicId;
                    const replyId = addDecisionReplyBtn.dataset.replyId;
                    const topic = discussionLog.find(t => t.id === topicId);
                    if (topic) {
                        const reply = topic.replies.find(r => r.id === replyId);
                        if (reply) {
                            const decisionText = `[回應] ${reply.speaker}: ${reply.statement}`;
                            if (!decisions.includes(decisionText)) {
                                decisions.push(decisionText);
                                renderDecisions();
                                saveDraft(); // *** 儲存草稿 ***
                                addDecisionReplyBtn.classList.remove('text-yellow-500');
                                addDecisionReplyBtn.classList.add('text-green-500');
                            }
                        }
                    }
                    return;
                }
            });

            // --- 綁定表單提交 (Firebase 版) ---
            generateMinutesBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const title = document.getElementById('meeting-title').value;
                const date = document.getElementById('meeting-date').value;
                const location = document.getElementById('meeting-location').value;
                const recorder = document.getElementById('meeting-recorder').value;
                const attendeesText = document.getElementById('meeting-attendees').value;
                const agendaText = document.getElementById('meeting-agenda').value;
                
                // 抓取當前待辦事項的快照
                const actionsSnapshot = [...actions.map(a => ({...a}))];
                // 移除 docId，因為它只在本地有用
                actionsSnapshot.forEach(a => delete a.docId);

                const newMeeting = {
                    title, date, location, recorder,
                    attendees: attendeesText, 
                    agenda: agendaText,     
                    decisions: [...decisions], 
                    discussionLog: [...discussionLog], 
                    actions: actionsSnapshot, // 儲存待辦快照
                    createdAt: serverTimestamp(),
                    ownerId: currentUserId // 標記建立者
                };
                
                try {
                    if (editingMeetingId) {
                        // 更新
                        const meetingRef = doc(db, 'meetings', editingMeetingId);
                        await setDoc(meetingRef, newMeeting, { merge: true }); // 使用 merge 以防萬一
                        editingMeetingId = null; 
                    } else {
                        // 新增
                        await addDoc(collection(db, 'meetings'), newMeeting);
                    }
                    
                    await clearDraft(); // 清除草稿
                    resetFormOnly(); // 清空本地表單
                    
                    // 產生 HTML (給預覽頁)
                    const htmlOutput = generateMeetingHtml(newMeeting);
                    formattedMinutes.innerHTML = htmlOutput;
                    mainContentContainer.classList.add('hidden'); 
                    outputContainer.classList.remove('hidden');
                    window.scrollTo(0, 0);
                    copySuccess.classList.add('hidden');

                } catch (e) {
                    console.error("儲存會議失敗:", e);
                    alert("儲存會議失敗！請檢查網路連線。");
                }
            });

            // --- 綁定複製/下載/重設 (Firebase 版) ---
            copyBtn.addEventListener('click', () => {
                const textOutput = generatePlainTextOutput(); 
                clipboardHelper.value = textOutput;
                clipboardHelper.select();
                try {
                    document.execCommand('copy');
                    copySuccess.classList.remove('hidden');
                    setTimeout(() => copySuccess.classList.add('hidden'), 2000);
                } catch (err) { console.error('複製失敗:', err); }
            });
            downloadBtn.addEventListener('click', () => {
                const title = document.getElementById('meeting-title').value.trim() || '會議記錄';
                const date = document.getElementById('meeting-date').value || '日期未填';
                const filename = `[${date}] ${title}.html`; 
                const htmlContent = document.getElementById('formatted-minutes').innerHTML;
                const styleContent = document.getElementById('document-styles').innerHTML;
                const fullHtml = `
                    <!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>${title}</title>
                    <style>body{margin: 2rem; font-family: 'Inter', 'Noto Sans TC', sans-serif;} ${styleContent}</style></head>
                    <body>${htmlContent}</body></html>`;
                const blob = new Blob(['\uFEFF', fullHtml], { type: 'text/html;charset=utf-8' }); 
                const href = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = href; a.download = filename;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); URL.revokeObjectURL(href);
            });
            
            // 重設按鈕 (返回編輯)
            resetBtn.addEventListener('click', async () => {
                mainContentContainer.classList.remove('hidden'); 
                outputContainer.classList.add('hidden'); 
                copySuccess.classList.add('hidden');
                
                // 重設表單 (會自動觸發草稿監聽器載入草稿)
                await clearDraft(); // 清除草稿
                resetFormOnly(); // 清空本地
                editingMeetingId = null; // 確保不在編輯模式

                tabButtons[0].click(); // 切回第一個分頁
            });
            
            // 只清空表單，不清除草稿 (用於登出)
            function resetFormOnly() {
                document.getElementById('meeting-title').value = '';
                document.getElementById('meeting-location').value = '';
                document.getElementById('meeting-recorder').value = '';
                document.getElementById('meeting-attendees').value = '';
                document.getElementById('meeting-agenda').value = '';
                document.getElementById('meeting-date').value = new Date().toISOString().split('T')[0];
                decisions = [];
                renderDecisions();
                editingDecisionIndex = null;
                addDecisionBtn.textContent = '新增決議';
                addDecisionBtn.classList.replace('bg-green-600', 'bg-blue-600');
                addDecisionBtn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                decisionInput.value = '';
                discussionLog = [];
                renderDiscussionLog();
                resetLogForm(); 
                personColorMap.clear(); 
                renderActions(); 
                editingMeetingId = null;
                const oldNotification = mainContentContainer.querySelector('.bg-yellow-100');
                if (oldNotification) oldNotification.remove();
                tabButtons[0].click();
            }
            
            // --- 待辦事項 Modal 相關 ---
            function populateEditModal(action) {
                modalActionId.value = action.docId; // *** 修改：使用 docId ***
                modalActionTitle.value = action.title;
                modalActionNotes.value = action.notes || ''; 
                modalActionOwner.value = action.owner;
                modalActionDue.value = action.due;
                modalActionStatus.value = action.status;
                modalActionUpdate.value = ''; 
                modalActionHistory.innerHTML = '';
                if (action.progressUpdates) {
                    action.progressUpdates.forEach(update => {
                        modalActionHistory.innerHTML += `<p><strong>${update.date}:</strong> ${update.update}</p>`;
                    });
                }
                modalActionHistory.scrollTop = modalActionHistory.scrollHeight; 
            }

            // --- 發言回應 Modal 相關 ---
            function showReplyModal(topicId, reply = null) {
                const topic = discussionLog.find(t => t.id === topicId);
                if (!topic) return;
                
                replyTopicId.value = topicId;
                replyToStatement.textContent = `${topic.speaker}: ${topic.statement.substring(0, 100)}...`;
                
                if (reply) {
                    // 編輯模式
                    replyModalTitle.textContent = "編輯回應";
                    saveReplyBtn.textContent = "儲存變更";
                    replyId.value = reply.id;
                    replySpeaker.value = reply.speaker;
                    replyStatement.value = reply.statement;
                } else {
                    // 新增模式
                    replyModalTitle.textContent = "新增回應";
                    saveReplyBtn.textContent = "儲存回應";
                    replyId.value = '';
                    replySpeaker.value = ''; // (可選) 自動填入 currentUserEmail
                    replyStatement.value = '';
                }
                replyModal.classList.remove('hidden');
                replySpeaker.focus();
            }
            function hideReplyModal() {
                replyModal.classList.add('hidden');
            }


            // --- 綁定過往會議 Modal (Firebase 版) ---
            viewPastMeetingsBtn.addEventListener('click', () => {
                renderPastMeetingsList(); // 重新渲染列表 (資料已由 onSnapshot 更新)
                pastMeetingContent.innerHTML = '<p class="text-slate-500">請從左側選擇一場會議來檢視內容。</p>';
                pastMeetingContent.dataset.currentId = ''; 
                pastMeetingsModal.classList.remove('hidden');
            });
            closePastModalBtn.addEventListener('click', () => pastMeetingsModal.classList.add('hidden'));
            pastMeetingsModal.addEventListener('click', (e) => {
                if (e.target === pastMeetingsModal) pastMeetingsModal.classList.add('hidden');
            });
            
            pastMeetingsList.addEventListener('click', async (e) => {
                const viewBtn = e.target.closest('.view-past-meeting-content');
                const editBtn = e.target.closest('.edit-past-meeting-btn');
                const deleteBtn = e.target.closest('.delete-past-meeting-btn'); 
                
                if (viewBtn) {
                    const id = viewBtn.closest('.data-item').dataset.id;
                    const meeting = meetings.find(m => m.docId === id);
                    if(meeting) {
                        const html = generateMeetingHtml(meeting);
                        pastMeetingContent.innerHTML = html;
                        pastMeetingContent.dataset.currentId = id; 
                    }
                    document.querySelectorAll('#past-meetings-list > div').forEach(div => div.classList.remove('bg-blue-200'));
                    viewBtn.closest('.data-item').classList.add('bg-blue-200');
                }
                
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const meeting = meetings.find(m => m.docId === id);
                    if (!meeting) return;
                    
                    // 載入會議資料
                    editingMeetingId = id;
                    document.getElementById('meeting-title').value = meeting.title;
                    document.getElementById('meeting-date').value = meeting.date;
                    document.getElementById('meeting-location').value = meeting.location;
                    document.getElementById('meeting-recorder').value = meeting.recorder;
                    document.getElementById('meeting-attendees').value = meeting.attendees; 
                    document.getElementById('meeting-agenda').value = meeting.agenda;     
                    decisions = [...meeting.decisions];
                    discussionLog = [...(meeting.discussionLog || [])]; 
                    renderDecisions();
                    renderDiscussionLog();
                    
                    // 將載入的會議儲存為新草稿
                    saveDraft(); 
                    
                    hidePastMeetingsModal();
                    window.scrollTo(0, 0);
                    
                    const notification = document.createElement('div');
                    notification.className = 'bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-3 rounded-lg mb-4 shadow-sm';
                    notification.textContent = `已載入「${meeting.title}」進行編輯。待辦事項為目前最新狀態。 (按下 "產生會議記錄" 將會覆蓋儲存)`;
                    const oldNotification = mainContentContainer.querySelector('.bg-yellow-100');
                    if (oldNotification) oldNotification.remove();
                    document.getElementById('tab-meeting').prepend(notification); 
                    setTimeout(() => {
                        if (notification.parentNode) notification.remove();
                    }, 5000);
                    tabButtons[0].click();
                }
                
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    const meeting = meetings.find(m => m.docId === id);
                    if (!meeting) return;
                    
                    showConfirmModal('刪除過往會議', `您確定要永久刪除「${meeting.title}」這筆會議記錄嗎？此操作無法復原。`, "確認刪除", async () => {
                        try {
                            await deleteDoc(doc(db, 'meetings', id));
                            // onSnapshot 會自動更新列表
                            if (pastMeetingContent.dataset.currentId === id) {
                                pastMeetingContent.innerHTML = '<p class="text-slate-500">請從左側選擇一場會議來檢視內容。</p>';
                                pastMeetingContent.dataset.currentId = '';
                            }
                        } catch(e) {
                            console.error("刪除會議失敗:", e);
                        }
                    });
                }
            });

            // --- 綁定自動儲存事件 ---
            const fieldsToSave = ['meeting-title', 'meeting-date', 'meeting-location', 'meeting-recorder', 'meeting-attendees', 'meeting-agenda'];
            fieldsToSave.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', saveDraft);
            });
            
            // --- 初始設定 ---
            document.getElementById('meeting-date').value = new Date().toISOString().split('T')[0];

        }); // DOMContentLoaded 結束
    </script>
</head>
<body class="bg-slate-50 text-slate-800 p-4 md:p-8">

    <!-- *** 新增：登入畫面 *** -->
    <div id="login-overlay" class="fixed inset-0 bg-slate-100 flex items-center justify-center z-[100]">
        <div class="bg-white p-10 rounded-2xl shadow-xl text-center max-w-md mx-auto">
            <h1 class="text-3xl font-bold text-slate-900 mb-4">會議記錄系統</h1>
            <!-- *** 修改：新增 ID *** -->
            <p id="login-message" class="text-slate-600 mb-8">這是一個團隊共享版，請登入您的 Google 帳號以開始使用。</p>
            <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center gap-2">
                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.1H42V20H24v8h11.3c-1.6 5.2-6.4 9-11.3 9-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.6-.4-3.9z"/><path fill="#FF3D00" d="m6.3 14.1 5.7 5.7C13.5 16.1 18.4 14 24 14c3.1 0 5.9 1.2 8 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4 16.3 4 9.7 8.3 6.3 14.1z"/><path fill="#4CAF50" d="m24 44c5.6 0 10.6-1.9 14.6-5.1l-5.7-5.7c-2.1 2-4.9 3.2-8 3.2-5.6 0-10.5-2.1-13.4-5.4l-5.7 5.7C9.7 40.7 16.3 44 24 44z"/><path fill="#1976D2" d="M43.6 20.1H42V20H24v8h11.3c-1.6 5.2-6.4 9-11.3 9-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.2l5.7-5.7C34.6 6.1 29.6 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20 20-8.9 20-20c0-1.3-.1-2.6-.4-3.9z"/></svg>
                使用 Google 帳號登入
            </button>
        </div>
    </div>

    <!-- *** 新增：主應用程式容器 (預設隱藏) *** -->
    <div id="app-container" class="hidden">

        <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-xl border border-slate-100">

            <div class="bg-gradient-to-r from-blue-500 to-sky-400 p-6 md:p-8 rounded-xl shadow-lg mb-10">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="text-white">
                        <h1 class="text-3xl font-bold">
                            會議記錄系統
                        </h1>
                        <!-- *** 新增：使用者狀態 *** -->
                        <div class="flex items-center gap-4 mt-2">
                            <span id="user-status" class="text-blue-100"></span>
                            <button id="logout-btn" class="hidden text-white font-medium text-sm bg-blue-700 hover:bg-white hover:text-blue-700 py-1 px-3 rounded-full">
                                登出
                            </button>
                        </div>
                    </div>
                    <div class="flex-shrink-0 mt-4 md:mt-0">
                        <button id="view-past-meetings-btn" class="bg-white text-blue-700 py-2 px-5 rounded-lg font-bold hover:bg-blue-50 shadow-md focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-blue-600">
                            檢視過往會議
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分頁切換 -->
            <div class="mb-8">
                <div class="border-b border-slate-200">
                    <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                        <button class="tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-lg text-blue-600 bg-blue-50" data-tab="tab-meeting">
                            本次會議記錄
                        </button>
                        <button class="tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-lg text-slate-500 hover:text-slate-700 hover:border-slate-300" data-tab="tab-actions">
                            待辦事項追蹤
                        </button>
                    </nav>
                </div>
            </div>


            <!-- 表單區域 -->
            <div id="minutes-form">
                <!-- 分頁 1 (會議) -->
                <div id="tab-meeting" class="tab-content active">
                    <!-- ... (基本資料表單) ... -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="meeting-title" class="block text-sm font-medium text-slate-700 mb-2">會議標題</label>
                            <input type="text" id="meeting-title" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="請輸入會議標題" required>
                        </div>
                        <div>
                            <label for="meeting-date" class="block text-sm font-medium text-slate-700 mb-2">會議日期</label>
                            <input type="date" id="meeting-date" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="meeting-location" class="block text-sm font-medium text-slate-700 mb-2">會議地點 (或連結)</label>
                            <input type="text" id="meeting-location" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="請輸入會議地點或連結">
                        </div>
                        <div>
                            <label for="meeting-recorder" class="block text-sm font-medium text-slate-700 mb-2">記錄人</label>
                            <input type="text" id="meeting-recorder" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="您的姓名">
                        </div>
                        <div class="md:col-span-2">
                            <label for="meeting-attendees" class="block text-sm font-medium text-slate-700 mb-2">出席人員</label>
                            <textarea id="meeting-attendees" rows="3" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="請輸入出席人員姓名，用逗號或換行分隔"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="meeting-agenda" class="block text-sm font-medium text-slate-700 mb-2">會議目的 / 議程</label>
                            <textarea id="meeting-agenda" rows="4" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="條列說明此次會議的主要目的或討論項目"></textarea>
                        </div>
                    </div>

                    <!-- 動態區塊：重要決議 -->
                    <div class="mt-8">
                        <h2 class="text-xl font-semibold text-slate-900 mb-4 border-b border-slate-200 pb-2">重要決議</h2>
                        <div id="decisions-list" class="space-y-3 mb-4"></div>
                        <div class="flex items-center space-x-3">
                            <input type="text" id="decision-input" class="flex-grow w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="輸入一項決議">
                            <button type="button" id="add-decision-btn" class="flex-shrink-0 bg-blue-600 text-white py-3 px-5 rounded-lg font-medium hover:bg-blue-700 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                新增決議
                            </button>
                        </div>
                    </div>
                    
                    <!-- 發言記錄 -->
                    <div class="mt-8 bg-slate-50 p-4 md:p-6 rounded-xl shadow-inner border border-slate-200">
                        <h2 class="text-xl font-semibold text-slate-900 mb-4 border-b border-slate-200 pb-2">發言記錄 (討論串)</h2>
                        <div id="log-list" class="space-y-3 mb-4 max-h-96 overflow-y-auto pr-2"></div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <div class="md:col-span-1">
                                <label for="log-speaker" class="block text-sm font-medium text-slate-700 mb-1">發言人 (必填)</label>
                                <input type="text" id="log-speaker" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="發言人">
                            </div>
                            <div class="md:col-span-3">
                                <label for="log-statement" class="block text-sm font-medium text-slate-700 mb-1">新話題 (必填)</label>
                                <input type="text" id="log-statement" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="發起一個新話題">
                            </div>
                            <div class="md:col-span-4 flex justify-between items-center mt-2">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="log-is-motion" class="h-4 w-4 text-purple-600 border-slate-300 rounded focus:ring-purple-500">
                                    <span class="text-purple-700 font-medium">設為臨時動議</span>
                                </label>
                                <button type="button" id="add-log-btn" class="bg-blue-600 text-white py-3 px-5 rounded-lg font-medium hover:bg-blue-700 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    新增話題
                                </button>
                            </div>
                            <div id="log-error" class="text-red-600 text-sm text-center md:col-span-4 hidden">
                                請填寫「發言人」和「新話題」
                            </div>
                        </div>
                    </div>

                    <!-- 產生按鈕 -->
                    <div class="mt-10 text-center">
                        <button type="submit" id="generate-minutes-btn" class="w-full md:w-auto bg-green-600 text-white text-lg font-bold py-4 px-10 rounded-lg shadow-lg hover:bg-green-700 transition-colors transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                            產生會議記錄
                        </button>
                    </div>
                </div> <!-- 結束 Tab 1 -->

                <!-- 分頁 2 (待辦) -->
                <div id="tab-actions" class="tab-content">
                    <div class="bg-slate-50 p-4 md:p-6 rounded-xl shadow-inner border border-slate-200">
                        <h2 class="text-xl font-semibold text-slate-900 mb-4 border-b border-slate-200 pb-2">待辦事項追蹤 (團隊共享)</h2>
                        <p class="text-sm text-slate-500 mb-4">
                            此清單團隊即時共享。
                        </p>
                        <div id="actions-list" class="space-y-4 mb-4"></div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-x-3 mb-1">
                            <label class="md:col-span-2 text-sm font-medium text-slate-700">主標題</label>
                            <label class="text-sm font-medium text-slate-700">負責人</label>
                            <label class="text-sm font-medium text-slate-700">截止日期</label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <input type="text" id="action-title" class="md:col-span-2 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="任務主標題 (必填)">
                            <input type="text" id="action-owner" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="負責人 (必填)">
                            <input type="date" id="action-due" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <div class="md:col-span-4">
                                <label for="action-notes" class="text-sm font-medium text-slate-700 mb-1 block">備註 (選填)</label>
                                <textarea id="action-notes" rows="2" class="w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="補充說明任務的詳細內容"></textarea>
                            </div>
                            <button type="button" id="add-action-btn" class="md:col-span-4 bg-blue-600 text-white py-3 px-5 rounded-lg font-medium hover:bg-blue-700 shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                新增待辦
                            </button>
                            <div id="action-error" class="text-red-600 text-sm text-center md:col-span-4 hidden">
                                請至少填寫「主標題」和「負責人」
                            </div>
                        </div>
                    </div>
                </div> <!-- 結束 Tab 2 -->
            </div> <!-- 結束 minutes-form (外層) -->

            <!-- 輸出預覽區域 (預設隱藏) -->
            <div id="output-container" class="hidden mt-10">
                <h2 class="text-3xl font-bold text-center text-slate-900 mb-8">會議記錄預覽</h2>
                <div id="formatted-minutes" class="bg-slate-50 border border-slate-200 p-6 md:p-10 rounded-lg shadow-inner prose max-w-none"></div>
                <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="download-btn" class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        下載為 .html (保留格式)
                    </button>
                    <button id="copy-btn" class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        複製文字內容
                    </button>
                    <button id="reset-btn" class="flex-1 bg-slate-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-slate-600 transition-colors shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">
                        返回編輯 / 新增
                    </button>
                </div>
                <div id="copy-success" class="text-center text-green-600 font-medium mt-4 hidden">
                    已成功複製到剪貼簿！
                </div>
            </div>
        </div> <!-- 主容器結束 -->
    </div> <!-- APP 容器結束 -->


    <!-- 所有 Modals (彈出視窗) -->
    <textarea id="clipboard-helper" style="position: absolute; left: -9999px;"></textarea>
    <div id="edit-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-2xl p-6 rounded-2xl shadow-xl m-4">
            <h3 class="text-xl font-bold mb-6 text-slate-900">編輯 / 更新待辦事項</h3>
            <input type="hidden" id="edit-action-id">
            <div class="space-y-4">
                <div><label for="modal-action-title" class="block text-sm font-medium text-slate-700">主標題</label><input type="text" id="modal-action-title" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="modal-action-notes" class="block text-sm font-medium text-slate-700">備註</label><textarea id="modal-action-notes" rows="3" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></textarea></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="modal-action-owner" class="block text-sm font-medium text-slate-700">負責人</label><input type="text" id="modal-action-owner" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></div>
                    <div><label for="modal-action-due" class="block text-sm font-medium text-slate-700">截止日期</label><input type="date" id="modal-action-due" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></div>
                </div>
                <div>
                    <label for="modal-action-status" class="block text-sm font-medium text-slate-700">任務狀態</label>
                    <select id="modal-action-status" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="pending">待處理</option><option value="in_progress">進行中</option><option value="done">已完成</option>
                    </select>
                </div>
                <div class="mt-4">
                    <h4 class="font-semibold text-slate-800">進度歷史</h4>
                    <div id="modal-action-history" class="mt-2 max-h-32 overflow-y-auto bg-slate-50 border border-slate-200 p-3 rounded-lg text-sm text-slate-600 space-y-1"></div>
                </div>
                <div><label for="modal-action-update" class="block text-sm font-medium text-slate-700">新增進度更新 (選填)</label><input type="text" id="modal-action-update" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500" placeholder="例如: 70%, 或 已完成初稿"></div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button type="button" id="cancel-edit-btn" class="bg-slate-200 text-slate-800 py-2 px-5 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">取消</button>
                <button type="button" id="save-action-btn" class="bg-blue-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">儲存變更</button>
            </div>
        </div>
    </div>
    <div id="reply-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full max-w-xl p-6 rounded-2xl shadow-xl m-4">
            <h3 id="reply-modal-title" class="text-xl font-bold mb-4 text-slate-900">新增回應</h3>
            <p class="text-sm text-slate-600 mb-4 bg-slate-100 p-3 rounded-lg"><strong>回應話題：</strong><span id="reply-to-statement" class="block mt-1"></span></p>
            <input type="hidden" id="reply-topic-id"><input type="hidden" id="reply-id">
            <div class="space-y-4">
                <div><label for="reply-speaker" class="block text-sm font-medium text-slate-700">發言人 (必填)</label><input type="text" id="reply-speaker" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></div>
                <div><label for="reply-statement" class="block text-sm font-medium text-slate-700">回應內容 (必填)</label><textarea id="reply-statement" rows="3" class="mt-1 w-full p-3 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500"></textarea></div>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button type="button" id="cancel-reply-btn" class="bg-slate-200 text-slate-800 py-2 px-5 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">取消</button>
                <button type="button" id="save-reply-btn" class="bg-blue-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">儲存回應</button>
            </div>
        </div>
    </div>
    <div id="past-meetings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-white w-full h-full max-w-6xl max-h-[90vh] p-6 rounded-2xl shadow-xl m-4 flex flex-col">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-200">
                <h3 class="text-2xl font-bold text-slate-900">會議記錄清單</h3>
                <button type="button" id="close-past-modal-btn" class="text-slate-500 hover:text-slate-800 p-2 rounded-full hover:bg-slate-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-grow flex flex-col md:flex-row gap-6 overflow-hidden">
                <div class="w-full md:w-1/3 h-full overflow-y-auto border border-slate-200 rounded-lg p-3 bg-slate-50">
                    <div id="past-meetings-list" class="space-y-2"><p class="text-slate-500">沒有儲存的會議...</p></div>
                </div>
                <div class="w-full md:w-2/3 h-full overflow-y-auto border border-slate-200 rounded-lg">
                    <div id="past-meeting-content" class="prose max-w-none p-6"><p class="text-slate-500">請從左側選擇一場會議來檢視內容。</p></div>
                </div>
            </div>
        </div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[60]"> 
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow-xl m-4">
            <h3 id="confirm-title" class="text-xl font-bold mb-4 text-slate-900">請確認</h3>
            <p id="confirm-message" class="text-slate-700 mb-6">您確定要執行此操作嗎？</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="confirm-cancel-btn" class="bg-slate-200 text-slate-800 py-2 px-5 rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2">取消</button>
                <button type="button" id="confirm-ok-btn" class="bg-red-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- 頁面 CSS 樣式 -->
    <style id="document-styles">
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 0.75rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose strong { font-weight: 600; }
        .prose .action-item-history { list-style-type: circle; margin-left: 1.5rem; margin-top: 0.25rem; font-size: 0.9rem; color: #4b5563; }
        button, .button { transition: all 0.2s ease-in-out; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .truncate-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        /* *** 修改：分頁樣式 *** */
        .tab-btn {
            border-color: transparent; /* 預設無底線 */
            transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
            font-weight: 500; /* 預設中等 */
            border-radius: 6px 6px 0 0;
        }
        .tab-btn.active { 
            border-color: #3b82f6; /* blue-500 */
            color: #2563eb; /* blue-600 */
            font-weight: 600; /* Active 時加粗 */
            background-color: #eff6ff; /* blue-50 */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</body>
</html>
